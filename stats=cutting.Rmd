# Bowling records
## Averages, all-time

Showing most wickets first

```{r bowl-avgs-alltime}
this_caption <- "Bowling averages, all time"

B.bowlingAverages %>% filter(club_id == conf$club_of_interest & !is.na(Name)) %>% arrange(desc(W), R) %>%
    select(all_of(H.clematis)) %>% 
kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)
```

## Averages, this year
```{r bowl-avgs-thisyear}
this_caption <- "Bowling averages, this year"

B.bowlingAveragesTY %>% filter(club_id == conf$club_of_interest & !is.na(Name)) %>% arrange(desc(W), R) %>%
    select(all_of(H.clematis)) %>% 
kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)
```

## Approaching milestones
```{r approaching-milestones-bowl}
this_caption <- "Approaching career total wicket milestones"

B.bowlingAverages %>% filter(club_id == conf$club_of_interest & !is.na(Name)) %>% 
    filter((W >= 90 & W < 100) | (W >= 240 & W < 250)) %>%
    arrange(desc(W), Avg) %>%
    select(all_of(H.clematis)) %>% 
kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) #%>%
```

## Best career economy

Minimum qualification: `r conf$qualify_balls_bowled` balls bowled
```{r bowl-avgs-alltime-lowecon}
this_caption <- "Lowest economy, all time"

B.bowlingAverages %>% 
  filter(club_id == conf$club_of_interest & !is.na(Name) & BB >= conf$qualify_balls_bowled) %>%
  slice_min(Econ, n=conf$default_list_length)%>%
    select(all_of(H.clematis)) %>% 
kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)
```

## Best career average

Minimum qualification: `r conf$qualify_balls_bowled` balls bowled
```{r bowl-avgs-alltime-lowavg}
this_caption <- "Lowest average, all time"

B.bowlingAverages %>% 
  filter(club_id == conf$club_of_interest & !is.na(Name) & BB >= conf$qualify_balls_bowled) %>%
  slice_min(Avg, n=conf$default_list_length)%>%
    select(all_of(H.clematis)) %>% 
kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)
```

## Most career five-fors

```{r bowl-avgs-alltime-most5}
this_caption <- "Most five-fors, all time"

B.bowlingAverages %>% 
  filter(club_id == conf$club_of_interest & !is.na(Name) & BB >= conf$qualify_balls_bowled) %>%
  arrange(Avg) %>%
  slice_max(`5wi`, n=conf$default_list_length)%>%
    select(all_of(H.clematis)) %>% 
kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)
```

## Highest average with a five-for

### Our club
```{r bowl-avgs-with-5for}
this_caption <- "Highest averages including a five-for, this season"

B.bowlingAveragesTY %>% 
  filter(club_id == conf$club_of_interest & !is.na(Name) & `5wi` >= 1) %>%
  
  slice_max(Avg, n=conf$default_list_length)%>%
    select(all_of(H.clematis)) %>% 
kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)
```

### All clubs in dataset
```{r bowl-avgs-with-5for-sphere}
this_caption <- "Highest averages including a five-for, this season"

B.bowlingAveragesTY %>% 
  filter(!is.na(Name) & `5wi` >= 1) %>%
  
  slice_max(Avg, n=conf$default_list_length)%>%
    select(all_of(H.clematis)) %>% 
kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)
```

## Four-fors this year
```{r fourfor-this-year}
this_caption <- "Four-fors this season"
a.numfourfors <- nrow(F.bowling.us %>% filter(W>=4 & year==conf$year_of_interest))
```
There have been `r a.numfourfors` four-fors so far this season.
```{r fourfor-this-year-2}
F.bowling.us %>% filter(W>=4 & year==conf$year_of_interest) %>% arrange(desc(W), R) %>%
    select(all_of(H.cyclamen)) %>% 
      kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)
```


## Four-fors without a team win
Showing most recent `r conf$default_list_length`:
```{r fourfor-no-win}
this_caption <- "Four-fors without team win"

F.bowling.us %>% filter(W >=4 & Res!="W" ) %>% slice_max(actuallyDate, n=conf$default_list_length) %>%
select(all_of(H.marigold)) %>% 
kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)  %>%  
   column_spec(6, width = "5em") %>%
  column_spec(7, width = "8em") %>%
  column_spec(8, width = "8em") %>%
  column_spec(9, width = "8em")
```

## Recent four-fors, for each team
Showing most recent `r conf$default_list_length`:

```{r fourfors-byteam, results='asis'}
#conf$teams_of_interest[[i]]
this_caption="Recent four-fors for "
for (i in 1:length(conf$teams_of_interest)) {
cat( paste("### ", names(conf$teams_of_interest)[i], " \n"))
  
F.bowling.us %>% filter(W >=4 & team_fielding_id == conf$teams_of_interest[[i]]) %>% 
  slice_max(actuallyDate, n=conf$default_list_length) %>%
select(all_of(H.marigold)) %>% 
kbl(longtable = T, booktabs = T, row.names = F, caption=paste(this_caption,names(conf$teams_of_interest)[[i]])) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)  %>%  
   column_spec(6, width = "5em") %>%
   column_spec(8, width = "7em") %>%
   column_spec(9, width = "7em") %>%

    print()
  
  cat ('\n\n')
}


```


## Dry spells
In current season:

```{r no-wickets}
this_caption <- "No wickets, highest runs conceded"

F.bowling.us %>% filter(W ==0 & year==conf$year_of_interest ) %>%
  slice_max(R, n=conf$default_list_length) %>%
select(all_of(H.marigold)) %>%
kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)  %>%
   column_spec(6, width = "5em") %>%
   column_spec(8, width = "7em") %>%
   column_spec(9, width = "7em")

```

## Outstanding analysis

### All years in dataset, our club
```{r strong-analysis-us}
this_caption <- "Outstanding analysis, our club, all years"
F.bowling.us  %>% arrange(desc(W), R) %>%
  slice_max(W, n=conf$default_list_length, with_ties = F) %>%
    select(all_of(H.cyclamen)) %>% 
      kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)
```

### This year, in our competitions
```{r strong-analysis-sph}
this_caption <- "Outstanding analysis, our competitions, this year"
F.bowling.sphere %>% filter(year == conf$year_of_interest)  %>% arrange(desc(W), R) %>%
  slice_max(W, n=conf$default_list_length, with_ties = F) %>%
    select(all_of(H.sunflower)) %>% 
      kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(6, width = "5em") %>%
     column_spec(7, width = "6em") %>%
   column_spec(8, width = "7em") %>%
   column_spec(9, width = "7em")
```

## Bowling through
This includes all innings, with no minimum length.

```{r bowl-through}
this_caption <- "Bowling all innings, our club, this year"
F.bowling.us  %>% 
  filter(O >= (inns_ovs_whole %/% 2) & year == conf$year_of_interest) %>%
  arrange(desc(W), R) %>%
    select(all_of(H.cyclamen)) %>% 
      kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
       column_spec(7, width = "8em") %>%
   column_spec(8, width = "8em")
```

\newpage

# Fielding records

## Most catches

Showing most recent, where tied

```{r most-catches}
this_caption <- "Most catches in an innings, our club"
F.fielding.us  %>% 
  arrange(desc(actuallyDate)) %>%
  #filter( year == conf$year_of_interest) %>%
  slice_max(Ct, n=conf$default_list_length, with_ties = F) %>%
    select(all_of(H.plum)) %>% 
      kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
  column_spec(5, width = "8em") %>%
       column_spec(6, width = "9em") %>%
   column_spec(7, width = "9em")

```

## Most stumpings
```{r most-stumping}
this_caption <- "Most stumpings in an innings, our club"
F.fielding.us  %>% 
  arrange(desc(actuallyDate)) %>%
  #filter( year == conf$year_of_interest) %>%
  slice_max(Std, n=conf$default_list_length) %>%
    select(all_of(H.plum)) %>% 
      kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
  column_spec(5, width = "8em") %>%
       column_spec(6, width = "9em") %>%
   column_spec(7, width = "9em")

```

## Most dismissals
```{r most-dis}
this_caption <- "Most fielding dismissals in an innings, our club"
F.fielding.us  %>% 
  arrange(desc(actuallyDate)) %>%
  #filter( year == conf$year_of_interest) %>%
  slice_max(Dis, n=conf$default_list_length, with_ties = F) %>%
    select(all_of(H.plum)) %>% 
      kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
  column_spec(5, width = "8em") %>%
       column_spec(6, width = "9em") %>%
   column_spec(7, width = "9em")
```

\newpage
# Team records -- `r conf$club_name`

## Our recent innings
```{r recent-inns}
this_caption <- "Recent club innings"

F.inningses.us %>% slice_max(actuallyDate, n=conf$default_list_length) %>% 
  select(all_of(H.dianthus)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
   column_spec(5, width = "12em") %>%
   column_spec(6, width = "10em")

##FIXME this should be matches presented in a nice format
```


## Highest innings totals

### Our competitions
```{r high-inns-sphere}
this_caption <- "Highest innings in our competitions"

F.inningses.sphere %>% slice_max(Runs, n=conf$default_list_length ) %>% 
  select(all_of(H.dianthus)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
   column_spec(5, width = "12em") %>%
   column_spec(6, width = "10em")
```

### Our matches at home grounds
```{r high-inns-home}
this_caption <- "Highest innings scored at home grounds"

F.inningses.circle %>% filter(ground_id %in% conf$home_grounds) %>% slice_max(Runs, n=conf$default_list_length ) %>% 
  select(all_of(H.dianthus)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
   column_spec(5, width = "12em") %>%
   column_spec(6, width = "10em")

```

### Our matches at away grounds
```{r high-inns-away}
this_caption <- "Highest innings scored at away grounds"

F.inningses.circle %>% filter(!ground_id %in% conf$home_grounds) %>% slice_max(Runs, n=conf$default_list_length ) %>% 
  select(all_of(H.dianthus)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
   column_spec(5, width = "12em") %>%
   column_spec(6, width = "10em")

```

## Highest innings totals losing one or no wickets
### Our competition
```{r high-inns-sphere-for1}
this_caption <- "Highest innings in our competitions for one or no wicket"

F.inningses.sphere %>% filter(W <= 1) %>% slice_max(Runs, n=conf$default_list_length ) %>% 
  select(all_of(H.dianthus)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
   column_spec(5, width = "12em") %>%
   column_spec(6, width = "10em")
```

### Our matches
```{r high-inns-circle-for1}
this_caption <- "Highest innings in our matches for one or no wicket"

F.inningses.circle %>% filter(W <= 1) %>% slice_max(Runs, n=conf$default_list_length ) %>% 
  select(all_of(H.dianthus)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
   column_spec(5, width = "12em") %>%
   column_spec(6, width = "10em")
```


## Lowest innings totals

Matches recorded as abandoned are excluded. Note that this also includes winning totals which reached 
an opponent's low total.

### Our competitions
```{r low-inns-sphere}
this_caption <- "Lowest innings in our competitions"

F.inningses.sphere %>% filter(Res !="A"  & Res !="C" & Runs != 0) %>% slice_min(Runs, n=conf$default_list_length ) %>% 
  select(all_of(H.dianthus)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
   column_spec(5, width = "12em") %>%
   column_spec(6, width = "10em")
```

### Our matches at home grounds
```{r low-inns-home}
this_caption <- "Lowest innings scored at home grounds"

F.inningses.circle %>% 
  filter(ground_id %in% conf$home_grounds & Res !="A" & Res !="C" & Runs != 0) %>% slice_min(Runs, n=conf$default_list_length ) %>%
  select(all_of(H.dianthus)) %>%
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
   column_spec(5, width = "12em") %>%
   column_spec(6, width = "10em")

```

### Our matches at away grounds
```{r low-inns-away}
this_caption <- "Lowest innings scored at away grounds"

F.inningses.circle %>% 
  filter(!ground_id %in% conf$home_grounds  & Res !="A" & Res !="C" & Runs != 0) %>%
  slice_min(Runs, n=conf$default_list_length ) %>%
  select(all_of(H.dianthus)) %>%
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
   column_spec(5, width = "12em") %>%
   column_spec(6, width = "10em")

```

## Ties
```{r ties}
this_caption <- "Tied innings"

F.inningses.sphere %>% filter(Res =="T") %>% arrange(desc(actuallyDate)) %>% 
  select(all_of(H.dianthus)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
   column_spec(5, width = "12em") %>%
   column_spec(6, width = "10em")
```

## Most extras

This section appears to contain spurious results.

### Our competition
```{r extras-sphere}
this_caption <- "Most extras in our competition"

F.inningses.sphere %>% slice_max(Extras, n=conf$default_list_length ) %>% 
  select(all_of(H.rudbeckia)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
  column_spec(5, width = "8em") %>%
   column_spec(6, width = "10em") %>%
   column_spec(7, width = "10em")

```

### Our matches
```{r extras-circle}
this_caption <- "Most extras in our matches"

F.inningses.circle %>% slice_max(Extras, n=conf$default_list_length ) %>% 
  select(all_of(H.rudbeckia)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
  column_spec(5, width = "8em") %>%
   column_spec(6, width = "10em") %>%
   column_spec(7, width = "10em")

```

## No byes conceded for total of 100 or more
```{r no-byes-100-total}
this_caption <- "No byes conceded for total of 150 runs or more, this season"

F.inningses.circle %>% filter(Runs >= 150 & Byes == 0 & year == conf$year_of_interest) %>% arrange(desc(Runs))%>% 
  select(all_of(H.wolfsbane)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
  column_spec(5, width = "8em") %>%
   column_spec(6, width = "10em") %>%
   column_spec(7, width = "10em")

```

## High successful chases
```{r high-chase}
this_caption <- "Highest successful run chases"

F.inningses.sphere %>% filter(match_innings == 2 & Res == "W") %>% slice_max(Runs, n=conf$default_list_length) %>% 
  select(all_of(H.dianthus)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
   column_spec(5, width = "12em") %>%
   column_spec(6, width = "10em")
```

## Highest match aggregate
This section appears to contain spurious results.

In all of our competitions
```{r high-match-agg}
this_caption <- "Highest match aggregate"

B.matches %>% filter(is_sphere) %>% slice_max(Aggregate, n=conf$default_list_length) %>% 
  select(all_of(H.freesia)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "10em") %>%
   column_spec(2, width = "10em") %>%
   column_spec(4, width = "10em")

```

## Most runs for a club in a day
```{r daily-agg}
this_caption <- "Highest daily aggregate for this club"
zxc <- aggregate(B.inningses$Runs, by=list(date = B.inningses$actuallyDate, club = B.inningses$club_id_bat), FUN="sum")
zxclen <- aggregate(B.inningses$Team, by=list(date = B.inningses$actuallyDate, club = B.inningses$club_id_bat), FUN="length")
zxc$clubChr <- as.character(zxc$club)
xcv <- left_join(zxc, D.club[,c("id", "name")], by = c("clubChr" ="id" ))
cvb <- left_join(xcv, zxclen, by = c("date" = "date", "club" = "club"))

a.runsinday <- cvb[cvb$club == as.character(conf$club_of_interest),c("date", "name", "x.x", "x.y")]
#slice_max(a.runsinday, x.x, n=25)
rm(zxc); rm(zxclen); rm(xcv); rm(cvb)

a.runsinday %>%
  rename(Club = name,
         Date = date,
         Aggregate = x.x,
         `No. of innings` = x.y,
         ) %>%

  slice_max(Aggregate, n=conf$default_list_length) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)
  

```

### All clubs in dataset
```{r daily-agg-all}
this_caption <- "Highest daily club aggregate"
zxc <- aggregate(B.inningses$Runs, by=list(date = B.inningses$actuallyDate, club = B.inningses$club_id_bat), FUN="sum")
zxclen <- aggregate(B.inningses$Team, by=list(date = B.inningses$actuallyDate, club = B.inningses$club_id_bat), FUN="length")
zxc$clubChr <- as.character(zxc$club)
xcv <- left_join(zxc, D.club[,c("id", "name")], by = c("clubChr" ="id" ))
cvb <- left_join(xcv, zxclen, by = c("date" = "date", "club" = "club"))

a.runsinday <- cvb[,c("date", "name", "x.x", "x.y")]
#slice_max(a.runsinday, x.x, n=25)
rm(zxc); rm(zxclen); rm(xcv); rm(cvb)

a.runsinday %>%
  rename(Club = name,
         Date = date,
         Aggregate = x.x,
         `No. of innings` = x.y,
         ) %>%

  slice_max(Aggregate, n=conf$default_list_length) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)
  

```

## Longest run of wins
This section may give unexpected results if more than one match played in a day.

It also appears to unhelpfully skip over missing data. 

```{r long-run-win, results='asis'}
# Although I wrote this I have no idea what I did to make it work, but it seems to.
this_caption <- "Long runs of consecutive wins"
for (i in 1:length(conf$teams_of_interest)) {
  cat( paste("### ", names(conf$teams_of_interest)[i], " \n"))
  
  zxc <- F.inningses.us %>% filter(team_batting_id == conf$teams_of_interest[[i]]) %>% arrange(desc(actuallyDate))
  zz <- zxc %>% pull(Res) %>% as.vector %>% rle()
  xcv <- tibble(l=zz$lengths, v= zz$values)
  # zz %>% filter(values == "W") %>% max()
  #yy %>% filter(v == "W") %>% slice_max(l)
  xcv$cse <- cumsum(xcv$l)
  xcv$cs <- xcv$cse - xcv$l + 1
  xx <- xcv %>% filter(v == "W") %>% slice_max(l)
  xx$Length <- xx$l
  xx$FromDate <- zxc[xx$cse,c(6)]
  xx$FromOppos <- zxc[xx$cse,c(42)]
  xx$ToDate <- zxc[xx$cs,c(6)]
  xx$ToOppos <- zxc[xx$cs,c(42)]
  xx %>% 
    
    select(c(Length, FromDate, FromOppos, ToDate, ToOppos)) %>% 
    kbl(longtable = T, booktabs = T, row.names = F, caption = paste(this_caption, names(conf$teams_of_interest)[i] )) %>%
    #latexify(D.club[D.club$id==conf$opponents_of_interest[i],"name"]) )) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
    print()
  
  cat ('\n\n')
  rm(zxc); rm(zz); rm(xcv); rm(xx)
}

```


## Longest run of losses

```{r long-run-loss, results='asis'}
this_caption <- "Long runs of consecutive losses"
for (i in 1:length(conf$teams_of_interest)) {
  cat( paste("### ", names(conf$teams_of_interest)[i], " \n"))
  
  zxc <- F.inningses.us %>% filter(team_batting_id == conf$teams_of_interest[[i]]) %>% arrange(desc(actuallyDate))
  zz <- zxc %>% pull(Res) %>% as.vector %>% rle()
  xcv <- tibble(l=zz$lengths, v= zz$values)
  # zz %>% filter(values == "W") %>% max()
  #yy %>% filter(v == "W") %>% slice_max(l)
  xcv$cse <- cumsum(xcv$l)
  xcv$cs <- xcv$cse - xcv$l + 1
  xx <- xcv %>% filter(v == "L") %>% slice_max(l)
  xx$Length <- xx$l
  xx$FromDate <- zxc[xx$cse,c(6)]
  xx$FromOppos <- zxc[xx$cse,c(42)]
  xx$ToDate <- zxc[xx$cs,c(6)]
  xx$ToOppos <- zxc[xx$cs,c(42)]
  xx %>% 
    
    select(c(Length, FromDate, FromOppos, ToDate, ToOppos)) %>% 
    kbl(longtable = T, booktabs = T, row.names = F, caption = paste(this_caption, names(conf$teams_of_interest)[i] )) %>%
    #latexify(D.club[D.club$id==conf$opponents_of_interest[i],"name"]) )) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
    print()
  
  cat ('\n\n')
  rm(zxc); rm(zz); rm(xcv); rm(xx)
}

```

## Shortest completed matches
In all of our competitions. 

This section appears to contain spurious results, and does not account for eight-ball 
overs in evening games.

```{r short-complete}
this_caption <- "Shortest completed matches"

B.matches %>% filter(is_sphere & toss !="" & result_applied_to != "") %>% slice_min(`decimal_overs`, n=conf$default_list_length) %>% 
  select(all_of(H.freesia)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
   column_spec(2, width = "12em") %>%
   column_spec(4, width = "10em")

```
## Proportions of extras
In matches with a result only, in our competitions of interest

```{r extras-prop, warning=FALSE, fig.height=4}
F.inningses.sphere %>% filter(Res %in% c("L", "W")) %>%

ggplot(aes(extras_proportion, Res)) +
geom_boxplot() +
  xlab("Proportion of extras in innings") +
  ylab("Result") +
  scale_x_continuous(labels = scales::percent)

```

```{r extras-prop-crit, results='asis'}
foo <- glm(Res ~ extras_proportion, F.inningses.sphere[F.inningses.sphere$Res %in% c("W", "L"),], family = binomial)
## todo  - read about logistic regression
a.extraspropwincrit <-  paste(format(( (0-foo$coefficients[[1]]) / foo$coefficients[[2]]) * 100, digits = 3),"%")
#exp(confint(foo))
cat("The critical point between likely win and likely loss is ", a.extraspropwincrit)
#summary(foo)
rm(foo)
```


<!-- ## Temperature -->
<!-- Do teams score more first innings runs when it is warm? Warning -- this is just for -->
<!-- fun, and uses unvalidated data for the maximum temperature in Cambridge on each day. -->

<!-- ```{r runs-and-temp,  warning=FALSE, fig.height=4, message=FALSE} -->

<!-- ggplot(F.inningses.sphere[F.inningses.sphere$match_innings==1,], aes(Runs, maxtemp)) + -->
<!--     geom_point() + -->
<!--     geom_smooth() + -->
<!--   ylab("Max temp in Cambridge, degrees C") + -->
<!--   xlab("First innings total") -->

<!-- ``` -->


<!-- ```{r runs-and-temp-coeffs, results='asis'} -->

<!-- zxc <- lm(F.inningses.sphere$Runs[F.inningses.sphere$match_innings==1] ~ F.inningses.sphere$maxtemp[F.inningses.sphere$match_innings==1]) -->

<!-- xcv <- confint(zxc) -->
<!-- #summary(zxc) -->

<!-- cat("Each degree rise in temperature increases first innings total by", -->
<!--       round(zxc[[1]][[2]], digits=2), "runs (95% CI:", -->
<!--       round(xcv[[2]][[1]], digits=2),",", round(xcv[[4]][[1]], digits=2), ").") -->
<!-- ``` -->



\newpage

# Opponents Report

## Batting averages, this year
```{r oppo-avgs, results='asis'}

this_caption="Opponent batting averages -- "
for (i in 1:length(conf$opponents_of_interest)) {
cat( paste("### ",  D.club[D.club$id==conf$opponents_of_interest[i],"name"]  , " \n"))
  
B.battingAveragesTY %>% filter(club_id == conf$opponents_of_interest[[i]]) %>% arrange(desc(Runs)) %>%
    select(all_of(H.aster)) %>% 
    kbl(longtable = T, booktabs = T, row.names = F, caption = paste(this_caption, "opp" )) %>%
      #latexify(D.club[D.club$id==conf$opponents_of_interest[i],"name"]) )) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
    print()
  
  cat ('\n\n')
}
```

## Bowling averages, this year
```{r oppo-bowl-avgs, results='asis'}

this_caption="Opponent bowling averages -- "
for (i in 1:length(conf$opponents_of_interest)) {
cat( paste("### ",  D.club[D.club$id==conf$opponents_of_interest[i],"name"]  , " \n"))
  
B.bowlingAveragesTY %>% filter(club_id == conf$opponents_of_interest[[i]]) %>% arrange(desc(W)) %>%
    select(all_of(H.clematis)) %>% 
    kbl(longtable = T, booktabs = T, row.names = F, caption = paste(this_caption, "opp" )) %>%
      #latexify(D.club[D.club$id==conf$opponents_of_interest[i],"name"]) )) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
    print()
  
  cat ('\n\n')
}
```


## Approaching batting milestones
```{r opp-approaching-milestones-bat, results='asis'}
this_caption <- "Career total run milestones -- "

for (i in 1:length(conf$opponents_of_interest)) {
cat( paste("### ",  D.club[D.club$id==conf$opponents_of_interest[i],"name"]  , " \n"))
  
B.battingAverages %>% filter(club_id == conf$opponents_of_interest[[i]] & !is.na(Name)) %>% 
    filter((Runs >= 400 & Runs < 500) | (Runs >= 900 & Runs < 1000)) %>%
    arrange(desc(Runs)) %>%
    select(all_of(H.aster)) %>% 
kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
    print()
  
  cat ('\n\n')
}



```

## Approaching bowling milestones
```{r opp-approaching-milestones-bowl, results='asis'}
this_caption <- "Career total wicket milestones -- "

for (i in 1:length(conf$opponents_of_interest)) {
cat( paste("### ",  D.club[D.club$id==conf$opponents_of_interest[i],"name"]  , " \n"))
  
B.bowlingAverages %>% filter(club_id == conf$opponents_of_interest[[i]] & !is.na(Name)) %>% 
    filter((W >= 45 & W < 50) |(W >= 90 & W < 100) | (W >= 240 & W < 250)) %>%
    arrange(desc(W)) %>%
    select(all_of(H.clematis)) %>% 
kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
    print()
  
  cat ('\n\n')
}
```

## Opponent's recent innings
```{r recent-inns-opp, results='asis'}
##FIXME this should be matches presented in a nice format
this_caption <- "Recent opponent innings -- "
for (i in 1:length(conf$opponents_of_interest)) {
cat( paste("### ",  D.club[D.club$id==conf$opponents_of_interest[i],"name"]  , " \n"))
  
B.inningses %>% filter(club_id_bat == conf$opponents_of_interest[[i]]) %>% slice_max(actuallyDate, n=conf$default_list_length) %>% 
  select(all_of(H.dianthus)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = paste(this_caption, "opp" )) %>% 
  # latexify(D.club[D.club$id==conf$opponents_of_interest[i],"name"]) )) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(1, width = "12em") %>%
   column_spec(5, width = "12em") %>%
   column_spec(6, width = "10em") %>%
    print()
  
  cat ('\n\n')
}

```

## Top batting in matches between us and opposition
```{r bestbat-opp, results='asis'}
this_caption <- "Batting against "
for (i in 1:length(conf$opponents_of_interest)) {
cat( paste("### ",  D.club[D.club$id==conf$opponents_of_interest[i],"name"]  , " \n"))
  
F.batting.circle %>% filter(club_id_bat == conf$opponents_of_interest[[i]] | club_id_field == conf$opponents_of_interest[[i]] ) %>% 
  
  slice_max(Runs, n=conf$default_list_length) %>% 
  select(all_of(H.aspidistra)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = paste(this_caption, "opp" )) %>%
  #latexify(D.club[D.club$id==conf$opponents_of_interest[i],"name"] ))) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(6, width = "10em") %>%
   column_spec(7, width = "10em") %>%
    print()
  
  cat ('\n\n')
}

```


## Top bowling in matches between us and opposition
```{r bestbowl-opp, results='asis'}
this_caption <- "Bowling against "
for (i in 1:length(conf$opponents_of_interest)) {
cat( paste("### ",  D.club[D.club$id==conf$opponents_of_interest[i],"name"]  , " \n"))
  
F.bowling.circle %>% filter(club_id_bat == conf$opponents_of_interest[[i]] | club_id_field == conf$opponents_of_interest[[i]] ) %>% 
 arrange(desc(W), R) %>%
  slice_max(W, n=conf$default_list_length, with_ties = F) %>%
  select(all_of(H.cyclamen)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F,   caption = paste(this_caption, "opp" )) %>%
  #latexify(D.club[D.club$id==conf$opponents_of_interest[i],"name"] ))) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
   column_spec(7, width = "10em") %>%
   column_spec(8, width = "10em") %>%
    print()
  
  cat ('\n\n')
}

```

