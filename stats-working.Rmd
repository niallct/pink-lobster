---
title: "Milton Stats"
#subtitle: "Season 2023"
author: "Niall Taylor"
date: "`r Sys.Date()`"
toc: true
toc_depth: 1
classoption: a4paper
#documentclass: cricalm
documentclass: article
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
source("parse-tidy.R")
source("displayFuncs.R")

## load the config
library(yaml)
conf <- yaml.load_file("./config/config.yaml")

# load other packages
library(tidyverse)
library(kableExtra)
library(lubridate)
#library(dplR) # provides latexify, need this for club names containing \&

# check the year of interest is sensible
if (nrow(B.matches %>% filter(Yr == conf$year_of_interest)) == 0){
  stop("ERROR: No data in year of interest.")}

# ---- define the output table column widths ----

# a standard font size
dfsz <- 7

#H.hyacinth <- c("Match Summary", "Date", "Result")
#H.phlox <- c("Match Summary", "Date", "Result", "Type", "Ground")
H.F.hyacinthfam <- function(x, this_caption, flower) x %>% select(all_of(flower)) %>%
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = dfsz) %>%
  column_spec(1, width = "25em") %>%
  column_spec(2, width = "6em") %>%
  column_spec(3, width = "12em")

H.F.phloxfam <- function(x, this_caption, flower) x %>% select(all_of(flower)) %>%
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = dfsz) %>%
  column_spec(1, width = "20em") %>%
  column_spec(2, width = "6em") %>%
  column_spec(3, width = "9em") %>%
  column_spec(5, width = "9em")


#H.freesia   <- c("Home Club", "Away Club", "Date", "Ground", "Match Aggregate", "Match Overs")
H.F.freesia <- function(x, this_caption, flower) x %>% select(all_of(flower)) %>%
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = dfsz) %>%
  column_spec(1, width = "8em") %>%
  column_spec(2, width = "8em") %>%
  column_spec(4, width = "6em")

# H.dianthus  <- c("Batting Side", "Score", "Ovs", "Date", "Fielding Side", "Ground", "Res")
# H.rudbeckia <- c("Batting Side", "Score", "Ovs", "Date", "Fielding Side", "Ground", "Res", "Extras")
# H.wolfsbane <- c("Batting Side", "Score", "Ovs", "Date", "Fielding Side", "Ground", "Res", "Byes")
# H.peony  <- c("Batting Side", "Score", "Ovs", "Date", "Fielding Side", "Ground", "Bowlers used")
H.F.dianthusfam <- function(x, this_caption, flower) x %>% select(all_of(flower)) %>%
  kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = dfsz) %>%
  column_spec(1, width = "8em") %>%
  column_spec(5, width = "8em") %>%
  column_spec(6, width = "7em")

# H.aspidistra <-  c("Name", "Runs", "Balls", "SR", "Date", "Type", "Fielding Club", "Ground", "Ven")
# H.lily <-        c("Name", "Runs", "Balls", "SR", "Date", "Team", "Fielding Club", "Ground",       "Res")

# H.hibiscus <-    c("Name", "Runs", "Balls", "SR", "Date", "Team", "Fielding Club", "Ground", "4", "6")
# H.safflower <-   c("Name", "Runs", "Balls", "SR", "Date", "Batting Club", "Fielding Club", "Ground", "How Out") 
# H.thistle <-     c("Name", "Runs", "Balls", "SR", "Date", "Fielding Club", "Opposition Score", "Contrib")


H.F.lilyfam <- function(x, this_caption, flower) x %>% select(all_of(flower)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), 
                font_size = dfsz)  %>% 
  column_spec(1, width = "9em") %>%
  column_spec(5, width = "6em") %>%
    column_spec(6:8, width = "9em") 

#H.cyclamen <-  c("Name", "O", "M", "R", "W",  "Date", "Fielding Side", "Batting Club", "Ground", "Res")
#H.lupin <-  c("Name", "O", "M", "R", "W", "Date", "Fielding Side", "Batting Club", "Ground", "Wd", "NB")

H.F.cyclamen <- function(x, this_caption, flower) x %>%    select(all_of(flower)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = dfsz) %>%
  column_spec(7, width = "6em") %>%
  column_spec(8, width = "6em")  %>%
  column_spec(9, width = "6em") 

# H.violet <- c("Match Summary", "Date", "Ground",  "Name", "Runs", "Balls", 
#               "O", "M", "R", "W", "Ct", "Std") 
H.F.violetfam <- function(x, this_caption, flower) x %>%    select(all_of(flower)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = dfsz) %>%
  column_spec(1, width = "8em") %>%
  column_spec(2, width = "4em") %>%
  column_spec(3, width = "4em") %>%
  column_spec(4, width = "4em") %>%
   column_spec(5, width = "1.5em") %>%
  column_spec(6, width = "1.5em") 

# H.primrose <- c("Date", "Batting Team", "Fielding Side", "Wkt", "Partnership", "Batter Out", "Batter Rem", "Ven")
# H.periwinkle <- c("Date", "Batting Team", "Fielding Side", "Wkt", "Partnership", "Batter Out", "Batter Rem", 
#                   "Score", "Oppo Score")
H.F.primrosefam <- function(x, this_caption, flower) x %>% select(all_of(flower)) %>%
  kbl(longtable = T, booktabs = T, row.names = F,   caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = dfsz) %>%
  column_spec(1, width = "6em") %>%
  column_spec(2:3, width = "9em") %>%
  column_spec(6:7, width = "9em") 



H.F.plain <- function(x, this_caption, flower) x %>%  
  select(all_of(flower)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"),
                font_size = dfsz) 


H.F.plainALL <- function(x, this_caption) x %>%  
  kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"),
                font_size = dfsz) 

```


\newpage
\setlength{\tabcolsep}{2pt}

# Almanack: `r conf$club_name`

Season `r conf$year_of_interest`. Latest match in dataset: `r B.dates$all_latest`.

## Batting
Strike rates calculated using only innings in which balls faced are recorded. 

### Batting averages
Showing highest average first. 
Qualification: `r conf$qualify_inns_avgs` innings.

```{r bat-avgs-thisyear}
F.batavg.us.ty %>% D.batavg.bestbatavgs("Batting averages, this year")
```

### Most runs

```{r mostruns-thisyear}
F.batavg.us.ty %>%  D.batavg.mostruns("Runs scored, this year")
```

### Most runs by match type
```{r mostruns-ty-type, message=FALSE, warning=FALSE, results='asis'}

map(levels(F.batting.us$Type), D.bat.totalrunsbytype, cap=paste("Most runs by match type"),
    df=F.batting.us.ty)
```

### Fifties this year
```{r fifties-this-year}
a.numfifties <- nrow(F.batting.us.ty %>%
                       filter(Runs>=50))
```
There have been `r a.numfifties` fifties so far this season.
```{r fifties-this-year-2}
F.batting.us.ty %>% D.bat.fifties("Fifties this season")
```

### Fifties without a team win
Showing most recent `r conf$default_list_length`:
```{r fifties-no-win}
F.batting.us.ty %>% D.bat.fiftieslosing("Fifties without team win")
```

### Consecutive fifties

Showing consecutive fifties
```{r consecutive-batmilestones-ty}
F.batting.us.ty %>% D.bat.consecbatms("Consecutive fifties, this year", 50)
```

### Recent fifties, for each team
Showing most recent `r conf$default_list_length`:

```{r fifties-byteam, results='asis'}
 #cat( paste("#### ", names(conf$teams_of_interest)[i], " \n"))
map(conf$teams_of_interest, D.bat.batmsteam, cap=paste("Recent fifties"), 
    df=F.batting.us, ms=50)
```


### Top individual scores, by match type

Showing scores over 35,

```{r high-inns-type-ty, results='asis'}

map(levels(F.batting.us.ty$Type), D.bat.highestscorebytype , 
    cap= "Highest innings this year in",
    min=35,
    df=F.batting.us.ty )
```

### Primaries this season
```{r primaries}
F.batting.us.ty %>% D.bat.primaries("Primaries this season")
```


### Most ducks this season
```{r ducks}
F.batting.us.ty %>%  D.bat.duckcount("Ducks this season")
```

### Longest duck this season
```{r longduck}
F.batting.us.ty %>%  D.bat.ducklength("Long ducks this season")

```

### Sixes so far this season
```{r sixes-thisyear}
F.batavg.us.ty %>% D.batavg.sixcount("Most sixes this season")
```

### Carried bat
Position 1 or 2 and not out. Care! May not be accurate if retirements involved.

```{r carried-bat}
F.batting.us.ty %>% D.bat.carriedbat("Carried bat, this year")
```

### Most times top scorer
```{r mosttopscorer}
F.batting.us.ty %>% D.bat.topscorercount("Count of times top scorer in an innings")
```


## Partnerships

In the partnerships section, retirements are not handled cleanly. Retirements
are common in friendly games, any appearance here of a high partnership in a
friendly is likely to be spurious.

### Top scores for each wicket, this year

Showing the top few for each wicket, all club, where over 25
```{r top-pship-ty, results='asis'}
map(1:10, D.fow.pshiptopwkt, cap=paste("Our top scores this year"), df=F.fow.us.ty)
```

## Bowling


### Bowling averages
Qualification: `r conf$qualify_inns_avgs` innings.

```{r bowl-avgs-thisyear}
F.bowlavg.us.ty %>% D.bowlavg.best("Bowling averages, this season")
```

### Most wickets
Showing most wickets first
```{r mostwkts-thisyear}
F.bowlavg.us.ty %>% D.bowlavg.wkt("Most wickets, this season")
```

### Most wickets by match type
```{r mostwickts-ty-type, message=FALSE, warning=FALSE, results='asis'}
map(levels(F.bowling.us.ty$Type) , D.bowl.mostwktstype, cap="Most wickets",
    df = F.bowling.us.ty)
```



### Four-fors this year 
```{r fourfor-this-year}
a.numfourfors <- nrow(F.bowling.us.ty %>% filter(W>=4))
```
There have been `r a.numfourfors` four-fors so far this season.
```{r fourfor-this-year-2}
F.bowling.us.ty %>% D.bowl.fourfors("Four-fors this season")
```

### Consecutive four-fors

```{r consec-4for-ty}
F.bowling.us.ty %>% D.bowl.consecbowlms("Consecutive four-fors", 4)
```


### Recent four-fors, for each team 
Showing most recent `r conf$default_list_length`:

```{r fourfors-byteam, results='asis'}

map(conf$teams_of_interest, D.bowl.msteam, cap=paste("Recent four-fors"), 
    df=F.bowling.us, ms=4)
```



### Dry days
```{r no-wickets}
F.bowling.us.ty %>% D.bowl.nowkts("No wickets, highest runs conceded")
```

### Outstanding analysis

In our matches and competitions

```{r strong-analysis-sph}
F.bowling.sphere.ty  %>%
  D.bowl.bestanalysis("Outstanding analysis, our competitions, this year")
```


### Best analysis by match type
```{r best-analy-type-ty, results='asis'}
map(levels(F.bowling.us.ty$Type), D.bowl.bestanalysistype, cap="Best analysis",
    df = F.bowling.us.ty)

```


### Highest average with a five-for

```{r bowl-avgs-with-5for}
F.bowlavg.us.ty %>% D.bowlavg.highavgwith5for("Highest averages including a five-for, this year")
```

### Gloves off

Bowling as designated wicketkeeper

```{r keeperbowl-ty}
F.allround.us.ty %>% D.allround.keeperbowling("Bowling this year as keeper")

```

## Team

### Results
```{r results-ty}
A.resultssummXI %>% D.resultsumm.resultsty("Our results this year")

```

### Matches this year

```{r matches-ty}
F.matches.circle.ty %>% D.match.matchview("Our matches this year")
```

### Quotients

Overall,
```{r quotients}
D.inns.quotients(F.inningses.us.ty,F.inningses.them.ty, "Quotients")
```

By team, 
```{r quotients-byteam, results='asis'}
map(conf$teams_of_interest, D.inns.teamquotients, cap=paste("Quotients"), 
    df=F.inningses.circle.ty)
```

### Our recent innings
```{r recent-inns}
F.inningses.us %>% D.inns.recentinns("Our recent club inns")
```

### Highest innings total
```{r high-inns-us-ty}
F.inningses.us.ty %>% D.inns.highinnstotal("Our highest innings totals, this season")
```

### Highest innings batting second
```{r high-inns-us-2-ty}
F.inningses.us.ty %>% D.inns.high2ndinns("Our highest innings totals batting second, this season")
```


### Highest match aggregate
This section appears to contain spurious results.

```{r high-match-agg-circle}
F.matches.circle.ty %>% D.match.highmatchagg("Highest match aggregate, this season")
```

### Lowest innings total
```{r low-inns-us-ty}
F.inningses.us.ty %>% D.inns.lowinnstotal("Our lowest innings totals, this season")
```

### Most extras
```{r most-extras-us}
F.inningses.us.ty %>% D.inns.mostextras("Most extras in our innings")
```

### Tossing performance

```{r tossing-ty}
F.inningses.us.ty %>% D.inns.tossresult("Our tossing and match results this year")
```
  
## All-rounder
### Thirty runs and three wickets in same match

```{r double-us-ty}
F.allround.us.ty %>% D.allround.matchdouble("Thirty and three-for", 30,3)

```

## Fielding

### Catches this year

Showing most first, including as wicket-keeper; most recent where tied.

```{r catches-thisyear}
F.fielding.us.ty %>% D.fielding.mostcatchesinns("Most catches in an innings, this year")


F.fieldsumm.us.ty %>% D.fieldsumm.mostcatches("Most total catches, this year")

```

### Victims per innings

Showing highest rate per innings, including as wicket-keeper. Qualification: four matches.

```{r victims-thisyear}
F.fieldsumm.us.ty %>% D.fieldsumm.mostdisperinns("Most dismissals per innings, this year")

```


## Wicket-keeping

### Dismissals this year, per innings

Showing most first; most recent where tied.

Excludes run-outs, because data are too flaky to be reliable.

```{r wkdiss-thisyear}
F.fielding.us.ty %>% D.fielding.mostblahinns( "Most WK catches in an innings, this year", "Ct")

F.fielding.us.ty %>% D.fielding.mostblahinns( "Most stumpings in an innings, this year", "Std")

F.fielding.us.ty %>% D.fielding.mostblahinns( "Most WK dismissals in an innings, this year", "Dis")

```

### Tally of dismissals, this year

Minimum: three.

```{r wkdiss-total-ty}
F.fielding.us.ty %>% D.fielding.mostblah("Most total WK catches, this year", "Ct")
F.fielding.us.ty %>% D.fielding.mostblah("Most total stumpings, this year", "Std")
F.fielding.us.ty %>% D.fielding.mostblah("Most total WK dismissals, this year", "Dis")

```


### No byes conceded for total of 150 or more
```{r no-byes-100-total-cy}
F.inningses.us.ty %>% D.inns.nobyes("No byes conceded for total of 150 runs or more, this season")

```


<!--
# Almanack: all clubs

TODO copy the local section -->

# Records: `r conf$club_name`

These are 'all-time' records. 'All time' means all of the dataset which is 
available, which may start after a player did.

## Batting
Strike rates calculated using only innings in which balls faced are recorded.

### Batting averages
Showing highest average first. 
Qualification: `r conf$qualify_inns_avgs` innings.

```{r bat-avgs-allt}
F.batavg.us %>% D.batavg.bestbatavgs("Batting averages, all time")
```

### Most runs

```{r mostruns-allt}
F.batavg.us %>%  D.batavg.mostruns("Career run totals")
```


### Most runs by match type
```{r mostruns-allt-type, message=FALSE, warning=FALSE, results='asis'}

map(levels(F.batting.us$Type), D.bat.totalrunsbytype, cap=paste("Most career runs by match type"),
    df=F.batting.us)
```


### Highest career strike rates
Minimum qualification: `r conf$qualify_balls_faced` balls faced
```{r bat-highSR-alltime}
F.batavg.us %>% D.batavg.highSR("Highest strike-rates, all time") 
```


### Most centuries
```{r centuries}
F.batavg.us %>% D.batavg.centurycount("Most centuries")
```

<!-- ### Most primaries -->
<!-- ```{r primary-all} -->
<!-- F.batting.us %>% D.bat.primarycount("Most primaries") -->
<!-- ``` -->

### Most ducks
```{r ducks-all, message=FALSE, warning=FALSE}
F.batting.us %>%  D.bat.duckcount("Count of ducks, all time")
```

### Longest duck
```{r longduck-all}
F.batting.us %>% D.bat.ducklength("Long ducks")
```

### Most times top scorer
```{r mosttopscorer-alltime}
F.batting.us %>% D.bat.topscorercount("Count of times top scorer in an innings")
```


### Fifty on debut
'Debut' here means the first recorded innings in the dataset, which may have started
after a player's actual debut.
```{r fifty-debut}
F.batting.us %>% D.bat.batmsdebut("Fifties on debut")
```

### Centuries without a team win
Showing most recent `r conf$default_list_length`:
```{r cent-no-win-allt}
F.batting.us %>% D.bat.fiftieslosing("Centuries without team win", 100)
```

### Consecutive centuries

Showing consecutive centuries
```{r consecutive-batmilestones}

F.batting.us %>% D.bat.consecbatms("Consecutive centuries", 100)

```

### Top individual scores

```{r top-bat-performances}
F.batting.us %>% D.bat.highestscore("All-time highest scores")

```

### Top individual scores for each team
```{r topbat-byteam, results='asis'}
map(conf$teams_of_interest, D.bat.highestscorebyteam , 
    cap= "Highest innings for",
    min=35,
    df=F.batting.us)
```

### Top individual scores, by match type
Showing scores over 35

```{r high-inns-type-allt, results='asis'}

map(levels(F.batting.us$Type), D.bat.highestscorebytype , 
    cap= "Highest innings in",
    min=35,
    df=F.batting.us)
```

### Approaching batting milestones

Only showing players active in current or previous season.

```{r approaching-milestones-bat}
B.batAvg %>% D.batavg.nearms(conf$club_of_interest)
```

### 200 runs before the end of May
```{r 200-end-May}
F.batting.us %>% D.bat.maybatms("200 runs in April and May")
```

### Highest strike rate in an innings
```{r top-strike-rates}
F.batting.us %>% D.bat.highSRinns("Highest SR in an innings")
```





### 500 runs in a season
```{r mostruns-season}
F.batting.us %>% D.bat.500season("500 runs in a season")
```

### Quickest to 500 in a season
Showing the date of match in which the 500th run was made
```{r quick500}
F.batting.us %>% D.bat.quickest500("Quickest to 500 in a season")
```

### Most fifties in a season
```{r mostfifties-season}
F.batting.us %>% D.bat.most50season("Most fifties in a season")
```

### Most boundaries in a season
```{r mostbounds-season}
F.batting.us %>% D.bat.mostbryseason("Most boundaries in a season")

```


### Monopolised batting
More than 60\% of the team's runs. Excludes scores of less than 10.

In March 1877, Charles Bannerman scored 165 from a team total of 245, 67.34\%.

```{r batting-monopoly}

F.batting.us %>% D.bat.bannerman("Monopolised runs", 0.6, 10)

```

### Batter outscoring the whole opposition

```{r outscore-opposition}
F.batting.us %>% D.bat.outscoringoppo("Outscoring the opposition")
```

### Most balls faced in an innings
```{r most-balls}
F.batting.us %>% D.bat.longinns("Longest innings")
```

### Most balls faced for a score 10 or less
```{r most-balls-lowscore}
F.batting.us %>% D.bat.longinns("Longest innings", 10)
```

### Most sixes in an innings
```{r most-sixes}
F.batting.us %>% D.bat.most6inns( "Most sixes in an innings")

F.batting.us %>% D.bat.mostBryinns("Most boundaries in an innings")
```

### Longest season without a boundary
```{r no-bdry-season}
F.batting.us %>% D.bat.nobdry.season("No boundaries in a season")
```

### Most career sixes
```{r career-sixes}
F.batavg.us %>% D.batavg.sixcount("Most career sixes")
```

### Most boundaries in an innings, for each team
```{r top4s-byteam, results='asis'}
map(conf$teams_of_interest, D.bat.mostBryinnsteam , 
    cap= "Most boundaries in an innings for",
    df=F.batting.us)
```


### Unusual dismissals
Out handled the ball, hit the ball twice, obstructing the field, timed out or hit wicket.

```{r unusual-dismissals}
F.batting.circle %>% D.bat.unusualdiss("Unusual dismissals, our matches")

#F.batting.sphere %>% D.unusualdiss("Unusual dismissals, our leagues")
```

### Carried bat
Position 1 or 2 and not out. Care! May not be accurate if retirements involved.

```{r carried-bat-at}
F.batting.us %>% D.bat.carriedbat("Carried bat")
```

### Tail end top scorer
Position 10 or 11 and top score, or equal top, with the bat. 

```{r tailend-top}
F.batting.us %>% D.bat.tailendtop("Tail enders top scoring")
```


### Fifties in the lower order
Batting 9, 10 or 11.

```{r loworder-fifty}
F.batting.us %>% D.bat.fiftiestailend("Fifties in the lower order")
```

## Partnerships

In the partnerships section, retirements are not handled cleanly. Retirements
are common in friendly games, any appearance here of a high partnership in a
friendly is likely to be spurious.

### Top scores for each wicket, all time

Showing the top few for each wicket, all club,
```{r top-pship-alltime, results='asis'}
map(1:10, D.fow.pshiptopwkt, cap=paste("Our top scores"), df=F.fow.us)
```

### Big partnerships
```{r big-pship}
F.fow.us %>% D.fow.highpship("Partnerships over 150, all time", 150)

```

### Partnerships dominating the innings
```{r dompships}

F.fow.us %>% D.fow.dompship("Partnership over 80\\% of the total")

```


### Partnerships outscoring the whole opposition
```{r pshipsoveropp}

F.fow.us %>% D.fow.pshipoveropp("Partnership outscoring the opposition")

```

### Partnerships by XI

Here, the friendly XIs are suppressed.
```{r pshipsbyXIall, message=FALSE, results='asis'}

map(conf$teams_formal_names, ~map(1:10,  D.fow.pshiptopwktXI, .x, cap=paste("Our top scores"), df=F.fow.us))
```

## Bowling

### Bowling averages
Qualification: `r conf$qualify_inns_avgs` innings.

```{r bowl-avgs-alltime}
F.bowlavg.us %>% D.bowlavg.best("Bowling averages, all time")
```

### Most wickets
Showing most wickets first
```{r mostwkts-alltime}
F.bowlavg.us %>% D.bowlavg.wkt("Most wickets, all time")
```

### Most wickets by match type
```{r mostwickts-allt-type, message=FALSE, warning=FALSE, results='asis'}
map(levels(F.bowling.us$Type) , D.bowl.mostwktstype, cap="Most wickets",
    df = F.bowling.us)
```

### Most wickets in a season
```{r mostwkts-season}
F.bowling.us %>% D.bowl.mostwktseason("Most wickets in a season")
```

### Lowest average in a season
Qualification: bowled in `r conf$qualify_inns_avgs` innings.

```{r bestavg-season}
F.bowling.us %>% D.bowl.bestavgseason("Best average in a season") 
```


### Four-for on debut
'Debut' here means the first recorded bowling instance in the dataset, which may
have started
after a player's actual debut. Fielding without bowling is not considered as debut for
this table; it is debut with the ball.

```{r fourfor-debut}
F.bowling.us %>% D.bowl.msdebut("Four-for on debut")
```

### Consecutive five-fors

```{r consec-5for}
F.bowling.us %>% D.bowl.consecbowlms("Consecutive five-fors", 5)
```


### Dry days
```{r no-wickets-allt}
F.bowling.us %>% D.bowl.nowkts("No wickets, highest runs conceded")
```


### All maidens

Qualification: two or more

```{r all-maidens}
F.bowling.us %>% D.bowl.allmaidens("All maidens")
```


### Outstanding analysis
```{r strong-analysis-us}
F.bowling.us  %>%
  D.bowl.bestanalysis("Outstanding analysis, our club, all years")
```

### Cheapest five-for
```{r cheap-5for}
F.bowling.us %>% D.bowl.cheap5for("Cheapest five-fors, our club, all years") 
```

### Highest average with a five-for

```{r bowl-avgs-with-5for-at}
F.bowlavg.us %>% D.bowlavg.highavgwith5for("Highest career averages including a five-for, all time")

```

### Gloves off

Best analysis when bowling as designated wicketkeeper

```{r keeperbowl}
F.allround.us %>% D.allround.keeperbowling("Bowling as keeper")
```



### Approaching milestones

Only showing players active in current or previous season.

```{r approaching-milestones-bowl}
B.bowlAvg %>% D.bowlavg.nearbowlms(conf$club_of_interest)
```


### Quickest to 40 wickets

Showing the date on which they took their 40th wicket

```{r fastest40}
F.bowling.us %>% D.bowl.fast40("Fastest to 40 wickets in a season")
```


### Best career economy
Minimum qualification: `r conf$qualify_balls_bowled` balls bowled
```{r bowl-avgs-alltime-lowecon}
F.bowlavg.us %>% D.bowlavg.econ("Lowest economy, all time")
```

### Best career strike-rate
Minimum qualification: `r conf$qualify_balls_bowled` balls bowled
```{r bowl-avgs-alltime-bestsr}
F.bowlavg.us %>% D.bowlavg.sr("Best strike rate, all time")
```

### Most career five-fors
```{r bowl-avgs-alltime-most5}
F.bowlavg.us %>% D.bowlavg.most5wi("Most five-fors, all time")
```

### Five-fors without a team win
Showing most recent `r conf$default_list_length`:
```{r fourfor-no-win}
F.bowling.us %>% D.bowl.fiveforlose("Five-fors without team win")
```

### Many bowlers used

Ten or more bowlers in an innings

```{r ten-bowlers-used}
F.inningses.them %>% D.inns.manybowlers("Many bowlers used", 10)
```

### Many bowlers taking wickets

Seven bowlers taking wickets in the same innings

```{r seven-wicket-takers}
F.inningses.them %>% D.inns.manywkttakers("Many bowlers taking wickets", 7)
```

### Bowlers with the same analysis

The scorecards for the Reach matches on 21 July 2019 and 9 August 2020 are 
unreliable. 

```{r same-analysis}
F.inningses.them %>% D.inns.samebowlanaly("Three or more bowlers with the same analysis", 3)
```

### Mostly extras

Showing bowling with 67% or more of runs conceded as wides or no-balls. Most recent `r conf$default_list_length`.
```{r mostextras-prop}
F.bowling.us %>% D.bowl.manyextras("Mostly extras", 66.5)
```



## Team

### Results
All teams, including friendlies and internal matches

```{r results}
A.resultssumm %>% D.resultsumm.results("Results by year")
```


### Good seasons
Most wins for a team in a season
```{r mostwins}
A.resultssummXI %>% D.resultsumm.mostwins("Most wins in a season")

```
### Quotients

Computed only on complete match records.

Overall,
```{r quotients-allt}

D.inns.quotients(F.inningses.us, F.inningses.them, "Quotients")

```

By team, 
```{r quotients-byteam-allt, results='asis'}
map(conf$teams_of_interest, D.inns.teamquotients, cap=paste("Quotients"), 
    df=F.inningses.circle)
```


### Highest innings totals

#### By us
```{r high-inns-us-allt}
F.inningses.us %>% D.inns.highinnstotal("Our highest innings totals, all time")
```

#### Against us
```{r high-inns-them-allt}
F.inningses.them %>% D.inns.highinnstotal("Our highest innings totals, all time")
```

#### Batting second
```{r high-inns-us-2-allt}
F.inningses.circle %>% D.inns.high2ndinns("Our highest innings totals batting second, all time")
```

#### Our matches at home grounds
```{r high-inns-home}
F.inningses.circle %>% 
  filter(ground_id %in% conf$home_grounds) %>%
  D.inns.highinnstotal("Highest innings at home grounds")
```

#### Our matches at away grounds
```{r high-inns-away}
F.inningses.circle %>% 
  filter(!ground_id %in% conf$home_grounds) %>%
  D.inns.highinnstotal("Highest innings at away grounds")
```

### Highest innings totals losing one or no wickets
#### By us
```{r high-inns-us-for1}
F.inningses.us %>% D.inns.highforone("Highest innings by us for one or no wicket")
```

#### Against us
```{r high-inns-circle-for1}
F.inningses.them %>% D.inns.highforone("Highest innings against us for one or no wicket")
```

### High successful chases
In our matches
```{r high-chase}
F.inningses.circle %>% D.inns.highchase("Highest successful run chases")
```

### High total but losing
```{r high-losing}
F.inningses.us %>% D.inns.highlosing("Highest losing totals")

```

### Lowest innings totals

Matches recorded as abandoned are excluded. Note that this also includes winning totals which reached 
an opponent's low total.

#### By us
```{r low-inns-us-allt}
F.inningses.us %>% D.inns.lowinnstotal("Our lowest innings totals, all time")
```

#### Against us
```{r low-inns-them-allt}
F.inningses.them %>% D.inns.lowinnstotal("Opponents' lowest innings totals, all time")
```

#### Our matches at home grounds
```{r low-inns-home}
F.inningses.circle %>% 
  filter(ground_id %in% conf$home_grounds) %>%
  D.inns.lowinnstotal("Lowest innings totals at home")
```

#### Our matches at away grounds
```{r low-inns-away}
F.inningses.circle %>% 
  filter(!ground_id %in% conf$home_grounds) %>%
  D.inns.lowinnstotal("Lowest innings totals away")
```

### Lowest runs per wicket

#### By us
```{r lowquotient-usbat}
F.inningses.us %>% D.inns.lowquot("Lowest runs/wkt, our batting")
```


#### Against us
```{r lowquotient-usbowl}
F.inningses.them %>% D.inns.lowquot("Lowest runs/wkt, our bowling")
```

### Highest runs per wicket

#### By us
```{r highquotient-usbat}
F.inningses.us %>% D.inns.highquot("Highest runs/wkt, our batting")
```

#### Against us
```{r highquotient-usbowl}
F.inningses.them %>% D.inns.highquot("Highest runs/wkt, our bowling")
```

### Highest total without batting milestones
In all of our matches
```{r hightotal-nomilestone-us}
# TODO output a short scorecard here

F.inningses.circle %>% D.inns.hightotalnocent("Highest totals without any individual century", 100)

F.inningses.circle %>% D.inns.hightotalnocent("Highest totals without any individual fifty", 50)

```

### Multiple batting milestones 
```{r multiplebat-milestones}
# TODO output a short scorecard here

F.inningses.circle %>% D.inns.manycentury("Innings with two or more centuries")

F.inningses.circle %>% D.inns.manyfifty("Innings with three or more fifties")

```

### All batters contributing
Qualification: six or more batters in the innings, all into double figures

```{r allbats-doublefigs-us}
# TODO output a short scorecard here
F.inningses.circle %>% D.inns.allbatscontrib("Innings with all (6+) batters making 10 or more", 10, 6)
```

### Winning with low individual scores

```{r win-low-indiv-score}
# TODO output a short scorecard here
F.inningses.circle %>% D.inns.lowindivid("Winning with no batter over 15", 15)
```

### High total with low individual scores

```{r hight-low-indiv-score}
# TODO output a short scorecard here
F.inningses.circle %>% D.inns.lowindividhightotal("High totals with no batter over 15", 15)
```


### Lowest top score

```{r low-indiv-score}
# TODO output a short scorecard here
F.inningses.circle %>% D.inns.lowhighestscore("Lowest top individual scores")
```

### Feast or famine

All batters scoring over 50 or less than 10

```{r no-middlescore}
F.inningses.us %>% D.inns.feastfamine("No-one between 10 and 50")
```

### Multiple bowling milestones 

Showing recent instances:

```{r multiplebowl-milestones}
# TODO output a short scorecard here

F.inningses.circle %>% D.inns.many4for("Innings with two four-fors",2)

F.inningses.circle %>% D.inns.allwkttakers("All bowlers taking at least two wickets")

```

### Conceding runs equitably

```{r equal-conceding-us}
# TODO output a short scorecard here
F.inningses.them %>% D.inns.equitbowl("Innings for 250+ with no bowler conceding 50", 250, 50)
```

### Highest total with few bowlers

In our matches. This appears vulnerable to missing data.

```{r high-tot-few-bowl}

F.inningses.circle %>% D.inns.hightotal4bowl("High total with four bowlers")
```



### Ties
```{r ties-us}
F.matches.circle %>% D.match.ties("Tied matches")
```


### Most extras
This section appears to contain spurious results.

#### Our batting
```{r most-extras-us-alltime}
F.inningses.us %>% D.inns.mostextras("Most extras in our innings, all time")
```

#### Our bowling
```{r most-extras-them-alltime}
F.inningses.them %>% D.inns.mostextras("Most extras in our innings, all time")
```


### No bowling extras
With us bowling,

```{r no-bowl-extras}
F.inningses.them %>% D.inns.nobowlextras("No bowling extras")
```


### Highest match aggregate
This section appears to contain spurious results.

```{r high-match-agg-circle-allt}
F.matches.circle %>% D.match.highmatchagg("Highest match aggregate")
```

### Lowest match aggregate
This section appears to contain spurious results.

In completed matches:

```{r low-match-agg-allt}
F.matches.circle %>% D.match.lowmatchagg("Lowest match aggregate")
```


### Shortest completed matches
This section appears to contain spurious results, and does not account for 
eight-ball overs in evening games.

```{r short-complete}
F.matches.circle %>% D.match.short("Shortest completed matches")
```

### High winning margins

#### 250 runs or more
```{r highmarginruns}
F.inningses.circle %>% D.inns.winmargin("Wins by 250 runs or more", 1, 250, op=`>=`)
```

#### 10 wickets
```{r highmarginwkts}
F.inningses.circle %>% D.inns.winmargin("Wins by 10 wickets", 2, 10)
```

### Narrow winning margins

#### By 1 run
```{r lowmarginruns}
F.inningses.circle %>% D.inns.winmargin("Wins by 1 run or more", 1, 1, op=`==`)
```

#### By 1 wicket
```{r lowmarginwkt}
a.win1wktUs <- F.inningses.us %>% W.inns.winmargin(2, 1, op=`==`) %>% nrow()

a.win1wktThem <- F.inningses.them %>% W.inns.winmargin(2, 1, op=`==`) %>% nrow()
```

We have won `r a.win1wktUs` and lost `r a.win1wktThem ` matches by one wicket.

### Most runs for the club in a day
```{r daily-agg}
D.inns.dayagg(F.inningses.us, "Highest daily aggregate, this club")
```

### Tossing performance

```{r tossing-all}
F.inningses.us %>% D.inns.tossresult("Our tossing and match results, all time")
```
  
  
## All-rounder

### Fifty runs and four wickets in same match

```{r little-double-us}
F.allround.us %>% D.allround.matchdouble("Fifty and four-for", 50,4)
```

### Hundred and five-for, our leagues

```{r double-sphere}
F.allround.sphere %>% D.allround.matchdouble("Hundred and five-for", 100, 5)
```

### Fifty runs and three fielding dismissals in same match

```{r fldr-double-us}
F.allround.us %>% D.allround.fielddouble("Fifty and three dismissals")
```

### Forty runs and four-for in consecutive matches
```{r 40-and-4for}
F.allround.us %>% D.allround.consecms("Forty and four-for in consecutive innings")
```

### Season double
500 runs and 20 wickets in a season

```{r season-double}
D.ar.seasondouble(F.batting.us, F.bowling.us, F.fielding.us, "Season double", 500, 20, 0)
```

500 runs and 10 dismissals

```{r season-fldg-double}
D.ar.seasondouble(F.batting.us, F.bowling.us, F.fielding.us, "Season double", 500, 0, 10)
```


### Career double
2000 runs and 50 wickets
```{r career-double-us}
# - allrounder := bat avg >= 15, <= 2.5 wkts/match
F.joinavgs.us %>% D.joinav.careerdouble("2000 runs and 50 wickets", 2000, 50, 0)
```

2000 runs and 50 fielding dismissals
```{r career-fldr-double-us}
F.joinavgs.us %>% D.joinav.careerdouble("2000 runs and 50 dismissals", 2000, 0, 50)
```

### Most appearances

```{r most-apps}

F.fielding.us %>% D.fielding.mostappsseason("Most appearances in a season")

F.fielding.us %>% D.fielding.appsalltime("Most appearances, all time")
```

## Fielding

### Most catches in an innings

Showing most first, including as wicket-keeper; most recent where tied.

```{r catches-inns}
F.fielding.us %>% D.fielding.mostcatchesinns("Most catches in an innings, all-time")
```

### Victims per innings

Showing highest rate per innings, including as wicket-keeper. Qualification: `r conf$qualify_inns_avgs` innings.

```{r victims-tally}
F.fieldsumm.us %>% D.fieldsumm.mostdisperinns("Most dismissals per innings, all-time", conf$qualify_inns_avgs)
```

### Tally of catches, all-time
Including as wicket-keeper.

```{r catches-total}
F.fieldsumm.us %>% D.fieldsumm.mostcatches("Most total catches, all time")
```

### Most catches by match type
```{r mostcatches-allt-type, message=FALSE, warning=FALSE, results='asis'}

map(levels(F.fielding.us$Type), D.fielding.totalcatchbytype, cap=paste("Most career catches by match type"),
    df=F.fielding.us)
```

### Most catches in a season
```{r mostcatch-season}
F.fielding.us %>% D.fielding.mostcatchseason("Most catches in a season")
```

## Wicket-keeping

### Most dismissals in an innings

Showing most first; most recent where tied.

Excludes run-outs, because data are too flaky to be reliable.

```{r wkdiss-alltime}
F.fielding.us %>% D.fielding.mostblahinns( "Most WK catches in an innings, all time", "Ct")

F.fielding.us %>% D.fielding.mostblahinns( "Most stumpings in an innings, all time", "Std")

F.fielding.us %>% D.fielding.mostblahinns( "Most WK dismissals in an innings, all time", "Dis")

```

### Most dismissals in a season
```{r mostwkdis-season}
F.fielding.us %>% D.fielding.mostblahseason("Most WK catches in a season", "Ct")
F.fielding.us %>% D.fielding.mostblahseason("Most stumpings in a season", "Std")
F.fielding.us %>% D.fielding.mostblahseason("Most WK dismissals in a season", "Dis")
```


### Tally of dismissals, all time
Minimum: three

```{r wkdiss-total}
F.fielding.us %>% D.fielding.mostblah("Most total WK catches, all time", "Ct")
F.fielding.us %>% D.fielding.mostblah("Most total stumpings, all time", "Std")
F.fielding.us %>% D.fielding.mostblah("Most total WK dismissals, all time", "Dis")

```




### Most WK dismissals by match type
```{r mostdis-allt-type, message=FALSE, warning=FALSE, results='asis'}
map(levels(F.fielding.us$Type),D.fielding.totalWKdisbytype, cap="Most WK dismissals by type",
    df = F.fielding.us)
```


### Most appearances as wicket-keeper

```{r most-apps-wk}
F.fielding.us %>% D.fielding.mostappsseason("Most appearances in a season", "As keeper")

F.fielding.us %>% D.fielding.appsalltime("Most appearances, all time", "As keeper")
```

### No byes conceded for high totals
```{r no-byes-200-total}
F.inningses.them %>% D.inns.nobyes("No byes conceded for total of 150 runs or more, this season", ms=200)

```

### Mutual assistance

Instances of keeper and bowler successfully swapping places, 
in all matches in the dataset.

```{r ames-freeman}
B.batting %>% D.bat.amesfreeman("Mutual assistance from keeper-bowlers")
```

## Grounds

Considering only matches involving our club:

### Most total runs at a ground

```{r mostruns-ground}
F.inningses.circle %>% D.inns.groundmostruns("Most runs at grounds")
```

### Highest team score at a ground

```{r highteamtotal-ground}
F.inningses.circle %>% D.inns.groundhighteam("Highest team total at grounds")
```

### Highest individual score at a ground

```{r highindiviscore-ground}
F.batting.circle %>% D.bat.groundhighindiv("Highest individual score at grounds")
```

### Highest scores at grounds with no fifty on record
```{r grounds-nofifty}
F.batting.circle %>% D.bat.groundhighindivno50("Highest individual score, low-scoring grounds")
```

<!--
# Records: all clubs

TODO copy the local section
-->

\newpage
# Experimental analyses

## Proportions of extras
In our matches with a result only.

```{r extras-prop, warning=FALSE, fig.height=4}

## TODO functionalise this before putting anywhere else
F.inningses.us %>% filter(Res %in% c("L", "W")) %>%
  ggplot(aes(extras_proportion, Res)) +
  geom_boxplot() +
  xlab("Proportion of extras in innings") +
  ylab("Result") +
  scale_x_continuous(labels = scales::percent)
```

```{r extras-prop-crit, results='asis'}
foo <- glm(Res ~ extras_proportion, F.inningses.sphere[F.inningses.sphere$Res %in% c("W", "L"),], family = binomial)
## todo  - read about logistic regression
a.extraspropwincrit <-  paste(format(( (0-foo$coefficients[[1]]) / foo$coefficients[[2]]) * 100, digits = 3),"%", sep = "")
#exp(confint(foo))
summary_foo <- summary(foo)

# Extract p-values for coefficients
p_values <- summary_foo$coefficients[, 4]
a.extraspropwincritpval <-  format(p_values[[2]], digits = 2)
cat("The critical point between likely win and likely loss is", a.extraspropwincrit, ", p =", a.extraspropwincritpval)

rm(foo); rm(summary_foo); rm(p_values)
```



## Substitute captains

Matches in which the on-field captain is not the elected captain for that
team and year. 

Totals since 2018:
```{r subcapt-most}


B.inningses %>% drop_na(`Batting Captain`, `Nominal Captain`) %>% 
  filter(`Batting Captain` != `Nominal Captain`, Yr > 2018) %>% 
  group_by(`Nominal Captain`) %>% tally() %>% 
  arrange(desc(n)) %>%
  H.F.plainALL("Most times substituted as captain")

B.inningses %>% drop_na(`Batting Captain`, `Nominal Captain`) %>% 
  filter(`Batting Captain` != `Nominal Captain`, Yr > 2018) %>% 
  group_by(`Batting Captain`) %>% tally() %>% 
  slice_max(n, n=conf$default_list_length) %>%
  H.F.plainALL("Most times acting as captain")

```

Most recent:

```{r subcapt}

B.inningses %>% drop_na(`Batting Captain`, `Nominal Captain`) %>% 
  filter(`Batting Captain` != `Nominal Captain`, Yr > 2018) %>% 
  slice_max(actuallyDate, n=conf$default_list_length) %>%
  select(Date, `Match Summary`, `Batting Captain`, `Nominal Captain`) %>%
  H.F.plainALL("Substitute captains")

```


## Long runs of substitution
```{r subcatt-longrun, results='asis'}

this_caption <- "Long runs of consecutive captaincy changes"

A.subcaptrun <-  B.inningses %>%  drop_na(`Batting Captain`, `Nominal Captain`) %>% 
  #filter(batting_team_id == conf$teams_of_interest[[3]]) %>% # filter fot the toi
  group_by(batting_team_id) %>%
  arrange(actuallyDate) %>% select(actuallyDate,
                                   Date, `Match Summary`, `Batting Captain`, `Nominal Captain`,
                                   `Batting Team`, batting_team_id) %>%
  mutate(#LastRes = lag(Res, default = 'A'),
    # ResRun = 1,
    # ResRun = case_when (
    #  (Res == LastRes) ~ lag(ResRun)+1,
    # TRUE ~ 1),
    streak_group = cumsum((`Batting Captain`== `Nominal Captain`) != lag((`Batting Captain`==`Nominal Captain`), default = TRUE)),
    streak_length = 1 + row_number() - match(streak_group, streak_group), 
    subcapt = !(`Batting Captain`== `Nominal Captain`)) %>% ungroup() 


zxclr <- A.subcaptrun %>% filter(subcapt == TRUE) %>% slice_max(streak_length) %>% select(streak_group, batting_team_id)



for (i in 1:nrow(zxclr)) {
  A.subcaptrun %>% filter(streak_group == zxclr$streak_group[i], batting_team_id == zxclr$batting_team_id[i]) %>% select(Date, `Match Summary`, `Batting Captain`, `Nominal Captain`) %>%
    kbl(longtable = TRUE, booktabs = TRUE, row.names = FALSE, caption = this_caption) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), 
                  font_size = 7) %>%
    column_spec(2, width= "6em") %>%
    print()
  
  cat('\n\n') }

# Remove unnecessary objects
rm(zxclr)


this_caption <- "Long runs of consecutive real captaincy"

zxclr <- A.subcaptrun %>% filter(subcapt == FALSE) %>% slice_max(streak_length) %>% select(streak_group, batting_team_id)


for (i in 1:nrow(zxclr)) {
  A.subcaptrun %>% filter(streak_group == zxclr$streak_group[i], batting_team_id == zxclr$batting_team_id[i]) %>% select(Date, `Match Summary`, `Batting Captain`, `Nominal Captain`) %>%
    kbl(longtable = TRUE, booktabs = TRUE, row.names = FALSE, caption = this_caption) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), 
                  font_size = 7) %>%
    column_spec(2, width= "6em") %>%
    print()
  
  cat('\n\n') }

# Remove unnecessary objects
rm(zxclr)


```

## Scorecard display
```{r scorecard, results="asis"}

scd <- B.inningses %>% filter(match_id==6450904)

scdh <- slice_head(scd)

cat(paste("### ", scdh$`Home Side`, "vs", scdh$`Away Side`, "\n\n",
      "At", scdh$Ground, "," , scdh$Date,". \n\n",
      scdh$Result, "\n\n")) #TODO add toss

makeScorecard <- function(data){
head <- paste("#### _",data$`Batting Club`,"_", sep="")

makebattSC <- function(x){
  if(is.na(x["runs"])){""} else{
    
    ballsshow <- if(is.na(x["balls"])){""} else {paste(" (", x["balls"], "b) ")}
    
  paste("+ ", x["batsman_name"], " \\dotfill ", makeHowOut(x["how_out"], x["bowler_name"], x["fielder_name"]), " ", x["runs"], ballsshow , sep="")}
  
}
batting <- str_trim(paste(apply(data$bat,1, makebattSC  ), 
                          collapse = "\n "), side="right")

#TODO hide if 0 
#TODO penalties

total <- paste(data$Byes,"b ", data$`Leg byes`,"lb ",data$Wides,"w ",data$`No-balls`,"nb. ",
               "Total ", data$Total, "/", data$W, " (", data$Ovs, " ovs)", sep="")

dnbnames <- paste(data$bat[which(data$bat[4]=="did not bat"),2], collapse = ", ")
dnbnames <- str_flatten_comma(data$bat[which(data$bat[4]=="did not bat"),2], last = " and ")

if(dnbnames==""){ dnb <- ""} else{ dnb <- paste(dnbnames, "did not bat.")} #TODO sort absent

fow <- "fow"

makeBowlSC <- function(x){
  
  paste(x["bowler_name"], " ", x["overs"], "-", x["maidens"], "-", x["runs"], "-", x["wickets"], sep="")
}
bowling <- paste(apply(data$bowl,1, makeBowlSC  ), collapse = ", ")

cat(paste(head, batting, total, dnb, fow, bowling, "\n", sep="\n\n "))
#paste(batting)
}

apply(scd, 1, makeScorecard)
rm(scd, scdh)

```

## Bowling through
This includes all innings, with no minimum length.

```{r bowl-through}
F.bowling.us  %>% 
  filter(O >= (decimal_overs %/% 2) & Yr == conf$year_of_interest) %>%
  arrange(desc(W), R) %>%
  H.F.cyclamen("Bowling all innings, our club, this year", H.cyclamen)
```

## Catching performance

Showing total catches and catches per innings split by whether the 
fielder is designated keeper. This appears to be missing some data; it is
not mandatory for a keeper to be designated.

```{r catchwk}
B.fielding %>% filter(is_sphere) %>% select(Yr, player_id, Capt, `W-K`, 
                                                actuallyDate, Ct, Std, RO, 
                                                fielding_club_id) %>%
  filter(fielding_club_id==conf$club_of_interest) %>%
  #select(`W-K`, Ct) %>% table()
  group_by(player_id, `W-K`) %>%
  summarise(`Ct/Inns`= sum(Ct) / n(),
            Ct = sum(Ct),
            Std= sum(Std),
            Inns = n()) %>% ungroup() %>% 
 # group_by(`W-K`) %>% summarise(avgci = mean(`Ct/Inns`))
  group_by(`W-K`) %>% summarise(Ct = sum(Ct),
                                Std = sum(Std),
                                I = sum(Inns),
                                `Ct/Inns`= sum(Ct) / sum(Inns))


A.playerswhokeep <- B.fielding %>% filter(`W-K`, !is.na(player_id)) %>% select(player_id) %>% unique() %>% pull()

A.catchesWKOF <- B.fielding %>% filter(is_sphere) %>% select(Yr, player_id, Capt, `W-K`, 
                                                actuallyDate, Ct, Std, RO, 
                                                fielding_club_id) %>%
 # filter(fielding_club_id==conf$club_of_interest) %>%
  #select(`W-K`, Ct) %>% table()
 filter(player_id %in% A.playerswhokeep) %>% 
  
  group_by(player_id, `W-K`) %>% 
  summarise(`Ct/Inns`= sum(Ct) / n(),
            Ct = sum(Ct),
            Std= sum(Std),
            Inns = n()) %>% ungroup() %>% 
  select(player_id, `W-K`, `Ct/Inns`) %>%
  pivot_wider(names_from = `W-K`, values_from = `Ct/Inns`) %>% ungroup() %>%
  rename(Keeper = `TRUE`, Outfield = `FALSE`) %>%
  mutate(difference = Keeper - Outfield)

#qqnorm(A.catchesWKOF$difference)
#qqline(A.catchesWKOF$difference, col = "red")
#shapiro.test(A.catchesWKOF$difference)
wilcox.test(A.catchesWKOF$Keeper, A.catchesWKOF$Outfield, paired=TRUE)

summary(A.catchesWKOF$Keeper)
summary(A.catchesWKOF$Outfield)


```

## Longest runs of results
This section may give unexpected results if more than one match played in a day.

It also appears to unhelpfully skip over missing data. 

```{r long-run-win, results='asis'}
this_caption <- "Long runs of consecutive results"

for (r in c('W', 'L')){
  hdg <- case_when(r == "W" ~ "wins", r=="L" ~ "losses")
  cat(paste("### Longest run of consecutive", hdg, "\n"))
for (i in 1:length(conf$teams_of_interest)) {
  
  # Print team name as a header
  cat(paste("#### ", names(conf$teams_of_interest)[i], " \n"))

zxc2 <-  F.inningses.us %>% filter(batting_team_id == conf$teams_of_interest[[i]]) %>% # filter fot the toi
                   arrange(actuallyDate) %>% select(actuallyDate, `Fielding Side`, Res,
                                                    Date, `Match Summary`, Result) %>%
  rename(Opposition = `Fielding Side`) %>%
                   mutate(#LastRes = lag(Res, default = 'A'),
                         # ResRun = 1,
                         # ResRun = case_when (
                         #  (Res == LastRes) ~ lag(ResRun)+1,
                         # TRUE ~ 1),
                          streak_group = cumsum(Res != lag(Res, default = first(Res))),
                          streak_length = 1 + row_number() - match(streak_group, streak_group)) 

zxclr <-   zxc2 %>% filter(Res == r) %>% slice_max(streak_length) %>% select(streak_group) %>% pull()

for (i in 1:length(zxclr)) {
zxc2 %>% filter(streak_group == zxclr[i]) %>% select(Date, `Opposition`, Result) %>%
    kbl(longtable = TRUE, booktabs = TRUE, row.names = FALSE, caption = this_caption) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), 
                  font_size = 7) %>%
    print()
  
  cat('\n\n') }

# Remove unnecessary objects
rm(zxc2, zxclr)
}
}
rm(r, i)
```

## Longest run of tossing performance

This is especially vulnerable to missing data. Matches with no toss recorded
are removed, as if they had never happened.

```{r tossing, results='asis'}

this_caption <- "Long runs of consecutive toss results"

for (r in c('W', 'L')){
  hdg <- case_when(r == "W" ~ "wins", r=="L" ~ "losses")
  cat(paste("### Longest run of consecutive toss", hdg, "\n"))
  for (i in 1:length(conf$teams_of_interest)) {
    
    # Print team name as a header
    cat(paste("#### ", names(conf$teams_of_interest)[i], " \n"))
    
    zxc2 <-  B.matches %>% filter(home_team_id == conf$teams_of_interest[[i]] |
                                    away_team_id == conf$teams_of_interest[[i]]) %>% # filter for the toi
      arrange(actuallyDate) %>% select(actuallyDate, Result, toss_won_by_team_id,
                                       Date, `Match Summary`) %>%
      mutate( `Toss result` = case_when(
        toss_won_by_team_id == conf$teams_of_interest[[i]] ~ "W",
        toss_won_by_team_id != conf$teams_of_interest[[i]] ~ "L"
      )) %>% drop_na(`Toss result`) %>%
     # filter(`Toss result` == "W") %>%
      mutate(
        streak_group = cumsum(`Toss result` != lag(`Toss result`, default = first(`Toss result`))),
        streak_length = 1 + row_number() - match(streak_group, streak_group)) 
    
    zxclr <-   zxc2 %>% filter(`Toss result` == r) %>% slice_max(streak_length) %>% select(streak_group) %>% pull()
    
    for (i in 1:length(zxclr)) {
      zxc2 %>% filter(streak_group == zxclr[i]) %>% select(Date, `Toss result`, `Match Summary`,  Result) %>%
        kbl(longtable = TRUE, booktabs = TRUE, row.names = FALSE, caption = this_caption) %>%
        kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), 
                      font_size = 7) %>%
        print()
      
      cat('\n\n') }
    
    # Remove unnecessary objects
    rm(zxc2, zxclr)
  }
}
rm(r)


```

## Totals in our leagues
```{r allclubsplot}
plot1 <- B.inningses %>%
  filter(league_id %in% conf$leagues_of_interest) %>%
  ggplot(aes(Total, colour= as.factor(league_id), na.rm = TRUE)) + 
  geom_density() +
  labs(title = paste("All totals"),
       colour="League ID",
       x="Total",
       y="Density")

plot(plot1)

```



\newpage

## Totals and winning, this club batting, all-time
```{r totalan-config}
#set the data source we are going to use
data <- F.inningses.us %>% filter(!is.na(`Total`), Total >0) 
```

### All batting innings

```{r p-totals-uty, echo=FALSE, message=FALSE, warning=FALSE}

plot <- data %>%   ggplot(aes(y=Total, 
                              na.rm = TRUE)) + geom_histogram(binwidth = 10) +
  geom_boxplot() +
  coord_flip() +
  #theme(axis.title.y=element_blank(),axis.text.y=element_blank(),
  #axis.ticks.y=element_blank() )+ 
  labs(title = paste("Totals") )

plot(plot)



data %>% select(`Total`) %>% pull() %>%
  summary()
```

### By venue or result

```{r p-totalsbyven}
plot1 <- data %>%
  ggplot(aes(x=actuallyDate, y=Total, col = Ven, shape = Res,
             na.rm = TRUE)) + geom_point() +
  labs(title = paste("All innings"),
       x="Date",
       col = "Venue",
       shape = "Result")

plot(plot1)

data %>%  select(`Total`, Ven) %>%
  group_by(Ven) %>%
 # summarise(
 #  Total_Median = median(Total, na.rm = TRUE)) %>%
  summarise(Stats = list(summary(Total))) %>% unnest_wider(Stats)

t.test(data %>% filter(Ven=="H") %>% select(Total),
       data %>% filter(Ven=="A") %>% select(Total))


### By result
data %>%  select(`Total`, Res) %>%
  group_by(Res) %>%
  summarise(Stats = list(summary(Total))) %>% unnest_wider(Stats)

t.test(data %>% filter(Res=="W") %>% select(Total),
       data %>% filter(Res=="L") %>% select(Total))

```

### By innings of match



```{r p-totalsbyiom}
plot2 <- data  %>%
  ggplot(aes(x=`Inns of match`, y=Total, 
             na.rm = TRUE)) + geom_boxplot() +
  geom_dotplot(binaxis = "y", stackdir='center', dotsize=1,  binwidth = 1) +
  labs(title = paste("Our totals"),
       x="Innings of match")



plot3 <- data  %>%
  ggplot(aes(x=actuallyDate, y=Total, col = `Inns of match`, 
             na.rm = TRUE)) + geom_point() +
  labs(title = paste("All innings"),
       x="Date",
       col = "Innings of match")

plot4 <- data %>%
  ggplot(aes(Total, colour= `Inns of match`, na.rm = TRUE)) + 
  geom_density() +
  labs(title = paste("Our totals"),
       colour="Inns of match",
       x="Total",
       y="Density")




plot(plot2)

plot(plot3)

plot(plot4)

### By innings of match
data %>%  select(`Total`, `Inns of match`) %>%
  group_by(`Inns of match`) %>%
  summarise(Stats = list(summary(Total))) %>% unnest_wider(Stats)

t.test(data %>% filter(`Inns of match`==1) %>% select(Total),
       data %>% filter(`Inns of match`==2) %>% select(Total))


```


### Over time
```{r totals-bytime}
### By year
data %>%  select(`Total`, Yr) %>%
  group_by(Yr) %>%
  summarise(Stats = list(summary(Total))) %>% unnest_wider(Stats) %>%
  arrange(desc(Yr))

### By month of the year
data %>%  select(`Total`, actuallyDate) %>%
  mutate(`Month` = format(actuallyDate, "%m")) %>% select(-actuallyDate) %>%
  group_by(`Month`) %>% # look into using %b for month name like May
  summarise(Stats = list(summary(Total))) %>% unnest_wider(Stats) 




```

### First innnings totals, by venue and result

```{r p-batfirst-uty, echo=FALSE, message=FALSE, warning=FALSE}
plot4 <- data %>%  filter(`Inns of match`==1) %>%
  ggplot(aes(x=Res, y=Total, 
             na.rm = TRUE)) + geom_boxplot() +
  geom_dotplot(binaxis = "y", stackdir='center', dotsize=1,  binwidth = 1) +
  labs(title = paste("Our first innings totals"),
       x="Result")

plot5 <- data %>%  filter(`Inns of match`==1) %>%
  ggplot(aes(Total, colour= Res, na.rm = TRUE)) + 
  geom_density() +
  labs(title = paste("Our first innings totals"),
       colour="Result",
       x="Total",
       y="Density")

plot6 <- data %>%  filter(`Inns of match`==1) %>%
  ggplot(aes(Total, colour= Ven, na.rm = TRUE)) + 
  geom_density() +
  labs(title = paste("Our first innings totals"),
       colour="Venue",
       x="Total",
       y="Density")

plot(plot4)

plot(plot5)

plot(plot6)

### Batting first only, by venue
data %>%  select(`Total`, `Inns of match`, Ven) %>%
  filter(`Inns of match` == 1) %>%
  group_by(Ven) %>%
  summarise(Stats = list(summary(Total))) %>% unnest_wider(Stats)

t.test(data %>% filter(`Inns of match`==1, Ven =='H') %>% select(Total),
       data %>% filter(`Inns of match`==1, Ven =='A') %>% select(Total))

### Batting first only, by result
data %>%  select(`Total`, `Inns of match`, Res) %>%
  filter(`Inns of match` == 1) %>%
  group_by(Res) %>%
  summarise(Stats = list(summary(Total))) %>% unnest_wider(Stats)

t.test(data %>% filter(`Inns of match`==1, Res =='W') %>% select(Total),
       data %>% filter(`Inns of match`==1, Res =='L') %>% select(Total))


```
### First innings totals by match type

```{r firstinns-type}
plot9 <- data %>%
  filter(`Inns of match`==1) %>%
  ggplot(aes(x=as.factor(no_of_overs), y=Total, 
             na.rm = TRUE)) + geom_boxplot() +
  geom_dotplot(binaxis = "y", stackdir='center', dotsize=1,  binwidth = 1) +
  labs(title = paste("Our totals, first inns"),
       x="Overs per inns")


plotA <- data %>%
  filter(`Inns of match`==1) %>%
  ggplot(aes(Total, colour= as.factor(no_of_overs), na.rm = TRUE)) + 
  geom_density() +
  labs(title = paste("Our totals, first inns"),
       colour="Overs per inns",
       x="Total",
       y="Density")

plotB <- data %>%
  filter(`Inns of match`==1) %>%
  ggplot(aes(x=Type, y=Total, 
             na.rm = TRUE)) + geom_boxplot() +
  geom_dotplot(binaxis = "y", stackdir='center', dotsize=1,  binwidth = 1) +
  labs(title = paste("Our totals, first inns"),
       x="Competition")


plotC <- data %>%
  filter(`Inns of match`==1) %>%
  ggplot(aes(Total, colour = Type, na.rm = TRUE)) + 
  geom_density() +
  labs(title = paste("Our totals, first inns"),
       colour="Competition",
       x="Total",
       y="Density")

plot(plot9)

plot(plotA)

plot(plotB)

plot(plotC)



```


### Results proportions

```{r propwin-uty}
plot <- data %>% filter(Res %in% c("W", "L")) %>%
  ggplot(aes(x=`Ven`, fill = `Res`,
             na.rm = TRUE)) + geom_bar(position = "dodge") +
  labs(title = paste("Results"),
       x="Venue",
       y="Count",
       fill = "Result"
  )

plot(plot)

plot <- data %>% filter(Res %in% c("W", "L")) %>%
  ggplot(aes(x=bat_first, fill= Res,
             na.rm = TRUE)) + geom_bar(position = "dodge") +
  labs(title = paste("Results"),
       x="Batting first",
       y="Count",
       fill="Result"
  )

plot(plot)

```

### Results proportion batting first

```{r propwinbatfirst-uty}
plot <- data %>% filter(`Inns of match`==1, Res %in% c("W", "L")) %>%
  ggplot(aes(x=`Ven`, fill = `Res`,
             na.rm = TRUE)) + geom_bar(position = "dodge") +
  labs(title = paste("Results batting first"),
       x="Venue",
       y="Count"
  )

plot(plot)

png('plot-winfirst.png')
plot(plot)
dev.off()



## Win proportion analysis

### Our matches, all time


# Logistic regression on batting first effect on result
# y = result, x = other stuff

A.innsres <- data %>% select(match_id, ground_id, Type, match_type,
                            bat_first,
                            innings_number, Total, Extras, W, Ovs, 
                            `Inns of match`,
                            actuallyDate, no_of_overs, Res, Ven)
A.innsres$is_win <- A.innsres$Res == "W"

model <- glm(is_win ~ Ven * bat_first,family=binomial(link='logit'),data=A.innsres)
#summary(model)
anova(model, test="Chisq")

```

## Run rates

```{r runrate-int}
#- a run rate analysis; min/max for/against
#create a clean df
zxc <- B.inningses %>% filter(is_sphere, decimal_overs > 0) %>% 
  drop_na(Total, decimal_overs) %>%
  select(batting_club_id, Yr, Res, Total, decimal_overs, `Inns of match`,
                       actuallyDate, us_batting, us_fielding) %>%
  mutate(`Run rate` = Total / decimal_overs,
         Role = case_when(  # friendly way to show our role
    us_batting == TRUE ~ 'Batting',
    us_fielding == TRUE ~ 'Bowling',
    us_batting == FALSE & us_fielding == FALSE ~ 'Neither',
    TRUE ~ NA
  ))

print(paste('After removing incomplete records,', nrow(zxc), 'remain.'))

```

### By whether this club batting

```{r runrate-role}
zxc %>% select(us_batting, `Run rate`) %>%
  group_by(us_batting) %>%
  summarise(Stats = list(summary(`Run rate`))) %>% unnest_wider(Stats)

wilcox.test(zxc %>% filter(us_batting == TRUE) %>% select(`Run rate`) %>% pull(),
       zxc %>% filter(us_batting == FALSE) %>% select(`Run rate`) %>% pull())
  

plot1 <- zxc  %>%
  ggplot(aes(y=`Role`, x=`Run rate`, 
             na.rm = TRUE)) + geom_boxplot() + 
  #geom_dotplot(binaxis = "y", stackdir='center', dotsize=1,  binwidth = 1) +
  labs(title = paste("Run rates"),
       y="This club's role") + 
  coord_cartesian(xlim = c(0, 18))
plot1

```


### By innings of match
```{r runrate-iom}
zxc %>% select(us_batting, `Run rate`) %>%
  group_by(us_batting) %>%
  summarise(Stats = list(summary(`Run rate`))) %>% unnest_wider(Stats)

wilcox.test(zxc %>% filter(`Inns of match`==1) %>% select(`Run rate`) %>% pull(),
       zxc %>% filter(`Inns of match`==2) %>% select(`Run rate`) %>% pull())

plot2 <- zxc  %>%
  ggplot(aes(y=`Inns of match`, x=`Run rate`, 
             na.rm = TRUE)) + geom_boxplot() + 
  #geom_dotplot(binaxis = "y", stackdir='center', dotsize=1,  binwidth = 1) +
  labs(title = paste("Run rates"),
       y="Innings of match") + 
  coord_cartesian(xlim = c(0, 18))
plot2



```


## Batting for multiple sides
```{r bat-mult-sides}
B.batAvg %>% group_by(batsman_id) %>% count() %>% ungroup() %>% filter(n>=5) %>%
  left_join(B.batAvg) %>% H.F.plain("Batting for many sides", H.asterC)

```
  
\newpage

# Opponents Report


```{r opponents, results='asis'}

for (i in 1:length(conf$opponents_of_interest)) {
  cat( paste("## ",  Y.clubs[Y.clubs$club_id==conf$opponents_of_interest[i],"club_name"]  , " \n"))
  
  E.batAvg.TY %>% filter(club_id == conf$opponents_of_interest[[i]]) %>%
    D.batavg.mostruns("Most runs this year") %>% print()
  
  cat ('\n\n')
  
  E.bowlAvg.TY %>% filter(club_id == conf$opponents_of_interest[[i]]) %>% 
    D.bowlavg.wkt("Most wickets this year") %>%  print()
  
  cat ('\n\n')
  
  F.batting.circle %>% filter(batting_club_id == conf$opponents_of_interest[[i]] |
                                fielding_club_id == conf$opponents_of_interest[[i]] ) %>% 
    D.bat.fifties("Fifties in our matches") %>%
    print()
  
  cat ('\n\n')
  
  F.bowling.circle %>% filter(batting_club_id == conf$opponents_of_interest[[i]] |
                                fielding_club_id == conf$opponents_of_interest[[i]] ) %>% 
    D.bowl.fourfors("Four-fors in our matches") %>%
    print()
  
  cat ('\n\n')
  
  B.inningses %>% filter(batting_club_id == conf$opponents_of_interest[[i]]) %>%
  D.inns.recentinns("Recent opponent innings") %>%   print()
  
  cat ('\n\n')
  
  F.matches.circle %>% 
    filter(conf$opponents_of_interest[[i]] == home_club_id |
             conf$opponents_of_interest[[i]] == away_club_id )%>%
    D.match.matchview("Our matches") %>% print()
  
  cat ('\n\n')
  
    B.batAvg %>% D.batavg.nearms(conf$opponents_of_interest[[i]]) %>% print()
  
  cat ('\n\n')
  
    B.bowlAvg %>% D.bowlavg.nearbowlms(conf$opponents_of_interest[[i]]) %>% print()
  
}
```

\newpage


# Setup

## Leagues and competitions
This year we played in the following competitions:

```{r ourleagues}
Y.compos %>% filter(ours==TRUE, current==TRUE) %>% select(id = competition_id,
                                                          Name = competition_name, 
                                                          league_id,
                                                          `League Name` = league_name) %>%
  kbl(longtable = T, booktabs = T, row.names = F) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"),
                font_size = 7) 
```

In the whole dataset, we have played in leagues with id 
numbers `r F.inningses.us %>% select(league_id) %>% distinct() %>% drop_na() %>%pull()` and
in `r F.inningses.us %>% select(competition_id) %>% distinct() %>% drop_na() %>% nrow()` distinct competitions.
<!-- in competitions with  -->
<!-- ids `r F.inningses.us %>% select(competition_id) %>% distinct() %>% drop_na() %>%pull() %>% sort()`.   -->


## Players

There are `r nrow(Y.currentplayers %>% filter(player_club==conf$club_of_interest))` recorded
playing for the club this season or last season, and `r nrow(Y.players)` in the whole
dataset.

## Date ranges
Data collected from Play-Cricket. 
For `r conf$club_name`, from `r B.dates$our_earliest` to `r B.dates$our_latest`,
n=`r B.dates$count_us` innings.  For all matches, from `r B.dates$all_earliest` to
`r B.dates$all_latest`, n=`r B.dates$count_all` innings.

## R session information
```{r session-info}
sessionInfo()
```

# Notes

The underlying dataset is collected from play-cricket, then processed and analysed. This 
report will therefore not include data which are missing from play-cricket, and 
will replicate errors from there. It is not, and cannot be, a complete record.

Records with missing data are interpreted as nicely as feels sensible, but in general are 
simply ignored. This usually results in the exclusion of part-complete data, probably
giving incorrect aggregate or average figures. A very few match scorecards are so 
unreliable that they are excluded.

Many tables presented here are one end of a filtered and sorted dataset. There 
is more interest 
in tops than in bottoms, though both are represented. The underlying data are versatile 
enough to output further, if requested, with appropriate preparation.

The author would appreciate being made aware of possible errors, so they can be explored.

No responsibility is taken for any purpose to which this report may be put. It should be 
viewed as mere entertainment, or for scholarly statistical purposes^[which are,
of course, inherently entertaining], and not relied upon as the sole judge of performance.
No assessment of an individual's performance is made or implied. 

_Comment is free, but stats are sacred._
