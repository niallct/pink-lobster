---
title: "Milton Stats"
#subtitle: "Season 2023"
author: "Niall Taylor"
date: "`r Sys.Date()`"
toc: true
toc_depth: 1
classoption: a4paper
#documentclass: cricalm
documentclass: article
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#source("get-data.R")
#source("../parse-raw-data.R", local = knitr::knit_global())
#load("./data/*")
load("./data/EbatAvgTY")
load("./data/BbatAvg")
load("./data/Bbatting")
load("./data/EbowlAvgTY")
load("./data/BbowlAvg")
load("./data/Bbowling")
load("./data/Edates")
load("./data/Bfielding")
load("./data/Binningses")
load("./data/Ematches")
load("./data/Eplayers")
load("./data/EplayersNC")

## load the config
library(yaml)
conf <- yaml.load_file("./config/config.yaml")
#conf$club_of_interest_name <- D.club$name[D.club$id== conf$club_of_interest] # this isn't neat, so just set it by hand in the yaml
# load other packages
library(tidyr)
library(dplyr)
library(kableExtra)
library(ggplot2)
#library(dplR) # provides latexify, need this for club names containing \&

# filter out for the club of interest
F.batting.us <- filter(B.batting, us_batting==TRUE)
F.batting.circle <- filter(B.batting,is_circle==TRUE) 
F.batting.sphere <- filter(B.batting,is_sphere==TRUE) 

F.bowling.us <- filter(B.bowling, us_fielding==TRUE)
F.bowling.circle <- filter(B.bowling,is_circle==TRUE) 
F.bowling.sphere <- filter(B.bowling,is_sphere==TRUE) 

F.inningses.us <- filter(B.inningses,us_batting==TRUE) 
F.inningses.circle <- filter(B.inningses,is_circle==TRUE) 
F.inningses.sphere <- filter(B.inningses,is_sphere==TRUE) 

F.fielding.us <- filter(B.fielding, us_fielding==TRUE) 
F.fielding.circle <- filter(B.fielding,is_circle==TRUE) 
F.fielding.sphere <- filter(B.fielding,is_sphere==TRUE) 

# get players for the club of interest
#MPbatters<- unique(MbattingBat$batsman_id) # FIXME

## Configure some heading sets for nice display
H.freesia   <- c("Home", "Away", "Date", "Ground", "Aggregate", "Overs in match")
H.dianthus  <- c("Team", "Score", "Ovs",           "Date", "Oppos","Ground", "Res")
H.rudbeckia <- c("Team", "Score", "Ovs", "Extras", "Date", "Oppos","Ground", "Res")
H.wolfsbane <- c("Team", "Score", "Ovs", "Byes",   "Date", "Oppos","Ground", "Res")


    
H.buckthorn <- c("Name", "Runs", "Inns", "NO", "Avg", "HS",                                      "6s", "4s")

H.aspidistra <-  c("Name", "Runs",           "Balls", "SR",           "Date",         "Fielding Club", "Ground", "Ven")

H.F.aspidistra <- function(x, this_caption, flower) x %>% select(all_of(flower)) %>%
      kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
    kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7) %>%
     column_spec(6, width = "8em") %>%
   column_spec(7, width = "8em")

H.lily <-        c("Name", "Runs", "Balls", "SR", "Date", "Team", "Fielding Club", "Ground",       "Res")
H.hibiscus <-    c("Name", "Runs", "Balls", "SR", "Date", "Team", "Fielding Club", "Ground", "4", "6")
H.safflower <-   c("Name", "Runs", "Balls", "SR", "Date", "Batting Club", "Fielding Club", "Ground", "How Out") 
H.thistle <-     c("Name", "Runs", "Balls", "SR", "Date", "Team", "Fielding Club", "Ground",       "Res", "Contrib")

H.F.lilyfam <- function(x, this_caption, flower) x %>% select(all_of(flower)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"), font_size = 7)  %>%  
   column_spec(6, width = "5em") %>%
   column_spec(7, width = "8em") %>%
   column_spec(8, width = "8em")


H.cyclamen <-  c("Name", "O", "M", "R", "W",  "Date",         "Oppos", "Ground", "Ven")
H.marigold <-  c("Name", "O", "M", "R", "W",  "Date", "Team", "Oppos", "Ground",       "Res")
H.sunflower <- c("Name", "O", "M", "R", "W",  "Date", "Club", "Oppos", "Ground",       "Res")

H.clematis <-  c("Name", "O", "M", "R", "W", "5wi", "Avg", "Econ", "SR", "Best")

H.plum <-   c("Name", "Ct", "Std","Date", "Club", "Oppos", "Ground") 



H.aster <-     c("Name", "Runs", "Inns", "NO", "Avg", "HS", "SR", "50", "100", "Ct", "Std", "RO")

H.F.plain <- function(x, this_caption, flower) x %>%  
  select(all_of(flower)) %>% 
  kbl(longtable = T, booktabs = T, row.names = F, caption = this_caption) %>%
  kable_styling(latex_options = c("repeat_header", "striped", "hold_position"),
                font_size = 7) 




# alyssum, crocosmia, hyacinth, iris, hydrangea, peony, mugwort, gladiolus, carnation, buddleia
```

Season `r conf$year_of_interest`

# This season

## Batting averages
Strike rates calculated using only innings in which balls faced are recorded. 

Showing most runs first

```{r bat-avgs-thisyear}

E.batAvg.TY %>% filter(club_id == conf$club_of_interest & !is.na(Name)) %>% arrange(desc(Runs)) %>% H.F.plain("Batting averages, this year", H.aster)

```


## Fifties this year
```{r fifties-this-year}
a.numfifties <- nrow(F.batting.us %>%
            filter(Runs>=50 & Yr==conf$year_of_interest))
```
There have been `r a.numfifties` fifties so far this season.
```{r fifties-this-year-2}
F.batting.us %>% filter(Runs>=50 & Yr==conf$year_of_interest) %>%
  arrange(desc(Runs)) %>%
   H.F.aspidistra("Fifties this season", H.aspidistra)
```

## Sixes so far this season
```{r sixes-thisyear}
this_caption <- "Sixes, this year"

E.batAvg.TY %>% filter(club_id == conf$club_of_interest & !is.na(Name) & !is.na(`4s`) & !is.na(`6s`)) %>%
  arrange(desc(`6s`), desc(`4s`)) %>%
  slice_max(`6s`, n=conf$default_list_length) %>%
   H.F.plain("Sixes this year", H.buckthorn)
```

## Fifties without a team win
Showing most recent `r conf$default_list_length`:
```{r fifties-no-win}
F.batting.us %>% filter(Runs >=50 & Res!="W" & Yr==conf$year_of_interest) %>% 
  slice_max(actuallyDate, n=conf$default_list_length) %>%
 H.F.lilyfam("Fifties without team win", H.lily)
```


## Recent fifties, for each team
Showing most recent `r conf$default_list_length`:

```{r fifties-byteam, results='asis'}

for (i in 1:length(conf$teams_of_interest)) {
cat( paste("### ", names(conf$teams_of_interest)[i], " \n"))
  
F.batting.us %>% filter(Runs >=50 & batting_team_id == conf$teams_of_interest[[i]] & Yr==conf$year_of_interest) %>% 
  slice_max(actuallyDate, n=conf$default_list_length) %>%
   H.F.lilyfam(paste("Recent fifties for ",names(conf$teams_of_interest)[[i]]), H.lily) %>% 
  print()
  cat ('\n\n')
}

```

## Primaries this year
```{r primaries}
F.batting.us %>% filter(Runs == 0  & Balls<= 1 & `How Out`!="not out" & Yr==conf$year_of_interest) %>%
arrange(desc(actuallyDate)) %>%
 H.F.aspidistra("Primaries", H.aspidistra)
```

# All-time records
 `All time' means all of the dataset which is available, which may start
 after a player did.

## Batting averages
Strike rates calculated using only innings in which balls faced are recorded.

Showing most runs first

```{r bat-avgs-alltime}

B.batAvg %>% filter(club_id == conf$club_of_interest & !is.na(Name)) %>%
  arrange(desc(Runs)) %>% H.F.plain("Batting averages, all time", H.aster)

```

## Approaching batting milestones
```{r approaching-milestones-bat}

B.batAvg %>% filter(club_id == conf$club_of_interest & !is.na(Name)) %>% 
    filter((Runs >= 400 & Runs < 500) | (Runs >= 900 & Runs < 1000)) %>%
    arrange(desc(Runs)) %>% H.F.plain("Approaching career total run milestones", H.aster)
```


## Highest career strike rates

Minimum qualification: `r conf$qualify_balls_faced` balls faced
```{r bat-avgs-alltime-highSR}

B.batAvg %>% filter(club_id == conf$club_of_interest & !is.na(Name) & BF >= conf$qualify_balls_faced) %>% slice_max(SR, n=conf$default_list_length)%>%
  H.F.plain("Highest strike-rates, all time", H.aster)
```

## Top career averages

Minimum qualification: `r conf$qualify_balls_faced` balls faced
```{r bat-avgs-alltime-highAvg}

B.batAvg %>% filter(club_id == conf$club_of_interest & !is.na(Name) & BF >= conf$qualify_balls_faced) %>% slice_max(Avg, n=conf$default_list_length)%>%
    H.F.plain("Highest averages, all time", H.aster)
```

## Most centuries
```{r centuries}
this_caption <- "Most centuries"
B.batAvg %>% filter(club_id == conf$club_of_interest & !is.na(Name)) %>%
  slice_max(`100`, n=conf$default_list_length) %>%
   H.F.plain("Most centuries", H.aster)
```

## Top individual scores
```{r top-bat-performances}
F.batting.us %>% slice_max(Runs, n=conf$default_list_length) %>%
   H.F.aspidistra("All-time top scores", H.aspidistra)
```

## Highest strike rates
```{r top-strike-rates}
F.batting.us %>% slice_max(SR, n=conf$default_list_length) %>%
  H.F.aspidistra("All-time top strike rates", H.aspidistra)
```


## Top performances for each team
```{r topbat-byteam, results='asis'}
for (i in 1:length(conf$teams_of_interest)) {
cat( paste("### ", names(conf$teams_of_interest)[i], " \n"))
  
F.batting.us %>% filter(batting_team_id == conf$teams_of_interest[[i]]) %>% 
  slice_max(Runs, n=conf$default_list_length) %>%
H.F.aspidistra(paste("Highest scores for ",names(conf$teams_of_interest)[[i]]), H.aspidistra) %>%
    print()
  
  cat ('\n\n')
}
```

## Highest strike rate, for each team
```{r topSR-byteam, results='asis'}
for (i in 1:length(conf$teams_of_interest)) {
cat( paste("### ", names(conf$teams_of_interest)[i], " \n"))
  
F.batting.us %>% filter(batting_team_id == conf$teams_of_interest[[i]]) %>% 
  slice_max(SR, n=conf$default_list_length) %>%
H.F.aspidistra(paste("Highest strike rate for ",names(conf$teams_of_interest)[[i]]), H.aspidistra) %>%
    print()
  
  cat ('\n\n')
}

```


## Monopolised batting
More than 60\% of the team's runs. Excludes scores of less than 10.

```{r batting-monopoly}
F.batting.us %>% filter(contribpc >= 0.6 & Runs >= 10) %>% arrange(desc(contribpc)) %>%
H.F.lilyfam( "Monopolised runs", H.thistle)
```


## Most balls faced in an innings
```{r most-balls}
this_caption <- "Most balls faced"
F.batting.us %>% slice_max(Balls, n=conf$default_list_length) %>%
  H.F.aspidistra("Most balls faced", H.aspidistra)
```

## Most balls faced for a score 10 or less
```{r most-balls-lowscore}
this_caption <- "Most balls faced for score 10 or less"
F.batting.us %>% filter(Runs <= 10) %>% slice_max(Balls, n=conf$default_list_length) %>%
  H.F.aspidistra("Most balls faced", H.aspidistra)
```

## Most sixes in an innings
```{r most-sixes}
this_caption <- "Most sixes in an innings"
F.batting.us %>% slice_max(`6`, n=conf$default_list_length) %>%
H.F.lilyfam("Most sixes in an innings", H.hibiscus)
```


## Most fours in an innings, for each team
```{r top4s-byteam, results='asis'}
for (i in 1:length(conf$teams_of_interest)) {
cat( paste("### ", names(conf$teams_of_interest)[i], " \n"))
  
F.batting.us %>% filter(batting_team_id == conf$teams_of_interest[[i]]) %>% 
  slice_max(`4`, n=conf$default_list_length) %>%
  H.F.lilyfam(paste("Most fours in an innings for " , names(conf$teams_of_interest)[[i]]), H.hibiscus) %>%
    print()
  cat ('\n\n')
}

```

## Carried bat
Position 1 or 2 and not out. Care! May not be accurate if retirements involved.
Showing the most recent `r conf$default_list_length`

```{r carried-bat}
F.batting.us %>% filter(Pos %in% c("1","2") & `How Out`=="not out") %>% arrange(desc(Runs)) %>%
    slice_max(actuallyDate, n=conf$default_list_length) %>%
H.F.lilyfam("Carried bat", H.lily)
```

## Unusual dismissals
Batters in matches in competitions of interest out
handled the ball, hit the ball twice, obstructing the field, timed out or hit wicket.

```{r unusual-dismissals}
unusual_dismissals <- c("handled ball", "hit ball twice", "obstructing the field", "timed out", "hit wicket")

F.batting.sphere %>% filter(`How Out` %in% unusual_dismissals) %>% arrange(desc(actuallyDate)) %>%
H.F.lilyfam("Unusual dismissals", H.safflower)
```

\newpage

# R session information
Data collected from Play-Cricket in August 2023.

```{r session-info}

sessionInfo()
```

# Notes

The underlying dataset is collected from play-cricket, then processed and analysed. This 
report will therefore not include data which are missing from play-cricket, and will replicate
errors from there. It is not, and cannot be, a complete record.

Records with missing data are interpreted as nicely as feels sensible, but in general are 
simply ignored. This may extend to the exclusion of part-complete data, probably giving
incorrect aggregate or average figures.

The author would appreciate being made aware of possible errors, so they can be explored.

No responsibility is taken for any purpose to which this report may be put. It should be 
viewed as mere entertainment, or for scholarly statistical purposes^[which are,
of course, inherently entertaining], and not relied upon as the sole judge of performance.
No assessment of an individual's performance is made or implied. 

_Comment is free, but stats are sacred._
